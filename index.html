<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Fablab Facility â€” Handy Platform</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* â•â•â• THEME â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root,[data-theme="dark"]{
  --bg:#0d0f14;--bg2:#12151c;--surface:#191d28;--surface2:#1f2436;--surface3:#252b3e;
  --border:#2a3048;--border2:#313854;
  --t1:#f0f2fa;--t2:#8a93b4;--t3:#4a5278;
  --shadow:0 4px 20px rgba(0,0,0,0.4);--shadow-sm:0 2px 8px rgba(0,0,0,0.3);
  --card-hover:rgba(255,255,255,0.02);--scrollbar-bg:#1f2436;--scrollbar-th:#313854;
  --modal-bg:rgba(0,0,0,0.75);--input-bg:#1f2436;
  --sb-bg:#12151c;--sb-border:#1e2438;--topbar-bg:#12151c;--topbar-border:#1e2438;
  --blue:#3b82f6;--blue2:#60a5fa;--blue-dim:rgba(59,130,246,0.12);
  --green:#22c55e;--green-dim:rgba(34,197,94,0.12);
  --yellow:#f59e0b;--yellow-dim:rgba(245,158,11,0.12);
  --red:#ef4444;--red-dim:rgba(239,68,68,0.12);
  --orange:#f97316;--orange-dim:rgba(249,115,22,0.12);
  --purple:#a855f7;--purple-dim:rgba(168,85,247,0.12);
  --teal:#14b8a6;--teal-dim:rgba(20,184,166,0.12);
}
[data-theme="light"]{
  --bg:#f0f2f8;--bg2:#e8eaf4;--surface:#fff;--surface2:#f5f6fc;--surface3:#eceef8;
  --border:#dde0f0;--border2:#c8cce0;
  --t1:#1a1d2e;--t2:#4a5278;--t3:#8a93b4;
  --shadow:0 4px 20px rgba(60,70,120,0.10);--shadow-sm:0 2px 8px rgba(60,70,120,0.07);
  --card-hover:rgba(0,0,0,0.015);--scrollbar-bg:#eceef8;--scrollbar-th:#c8cce0;
  --modal-bg:rgba(30,35,60,0.55);--input-bg:#f5f6fc;
  --sb-bg:#fff;--sb-border:#e0e3f2;--topbar-bg:#fff;--topbar-border:#e0e3f2;
  --blue-dim:rgba(59,130,246,0.10);--green-dim:rgba(34,197,94,0.10);
  --yellow-dim:rgba(245,158,11,0.10);--red-dim:rgba(239,68,68,0.10);
  --orange-dim:rgba(249,115,22,0.10);--purple-dim:rgba(168,85,247,0.10);
  --teal-dim:rgba(20,184,166,0.10);
}
/* â•â•â• BASE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*{box-sizing:border-box;margin:0;padding:0;}
html{height:100%;-webkit-tap-highlight-color:transparent;}
body{height:100dvh;background:var(--bg);color:var(--t1);font-family:'Plus Jakarta Sans',sans-serif;font-size:16px;line-height:1.6;overflow:hidden;transition:background .25s,color .25s;}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:var(--scrollbar-bg);}
::-webkit-scrollbar-thumb{background:var(--scrollbar-th);border-radius:4px;}
/* â•â•â• LAYOUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#app{display:flex;height:100dvh;overflow:hidden;}
#sidebar{width:240px;flex-shrink:0;background:var(--sb-bg);border-right:1px solid var(--sb-border);display:flex;flex-direction:column;overflow:hidden;transition:width .3s cubic-bezier(.4,0,.2,1),background .25s;z-index:50;}
#sidebar.collapsed{width:64px;}
#main{flex:1;overflow:hidden;display:flex;flex-direction:column;min-width:0;}
/* â•â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sb-header{padding:14px 14px 12px;border-bottom:1px solid var(--sb-border);display:flex;align-items:center;justify-content:space-between;gap:8px;min-height:58px;flex-shrink:0;}
.logo-wrap{display:flex;align-items:center;gap:9px;overflow:hidden;}
.logo-icon{width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,var(--blue) 0%,#6366f1 100%);display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;box-shadow:0 2px 10px rgba(59,130,246,0.35);}
.logo-text{overflow:hidden;}
.logo-name{font-size:1rem;font-weight:800;letter-spacing:-.03em;white-space:nowrap;}
.logo-name em{color:var(--blue);font-style:normal;}
.logo-sub{font-size:.58rem;color:var(--t3);letter-spacing:.12em;text-transform:uppercase;white-space:nowrap;}
.sb-collapse-btn{background:none;border:none;cursor:pointer;color:var(--t3);padding:4px;border-radius:6px;transition:all .15s;flex-shrink:0;font-size:.9rem;line-height:1;}
.sb-collapse-btn:hover{background:var(--surface3);color:var(--t1);}
/* Facility Selector */
/* facility-sel-wrap removed â€” replaced by fac-cards */
/* Nav */
.nav{flex:1;overflow-y:auto;padding:8px 8px;}
.nav-section{font-size:.58rem;letter-spacing:.14em;text-transform:uppercase;color:var(--t3);padding:10px 8px 4px;font-family:'JetBrains Mono',monospace;white-space:nowrap;overflow:hidden;transition:opacity .2s;}
#sidebar.collapsed .nav-section{opacity:0;height:0;padding:0;margin:0;}
.nav-btn{display:flex;align-items:center;gap:10px;padding:10px 10px;border-radius:8px;cursor:pointer;color:var(--t2);font-size:.85rem;font-weight:500;border:none;background:none;width:100%;text-align:left;position:relative;transition:all .15s;white-space:nowrap;overflow:hidden;margin-bottom:2px;}
.nav-btn:hover{background:var(--surface2);color:var(--t1);}
.nav-btn.active{background:var(--blue-dim);color:var(--blue2);}
.nav-btn.active::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:55%;background:var(--blue);border-radius:0 2px 2px 0;}
#sidebar.collapsed .nav-btn{justify-content:center;padding:10px;}
.nav-icon{font-size:1.15rem;width:22px;text-align:center;flex-shrink:0;}
.nav-lbl{flex:1;overflow:hidden;transition:opacity .2s,width .3s;}
#sidebar.collapsed .nav-lbl{opacity:0;width:0;}
.sub-nav{max-height:0;overflow:hidden;transition:max-height .25s cubic-bezier(.4,0,.2,1);}
.sub-nav.open{max-height:200px;}
.nav-sub{padding-left:28px !important;font-size:.82rem !important;opacity:.85;}
.nav-sub:hover{opacity:1;}
#sidebar.collapsed .sub-nav{display:none;}
.nav-badge{margin-left:auto;background:var(--red);color:#fff;font-size:.58rem;font-family:'JetBrains Mono',monospace;padding:2px 5px;border-radius:10px;min-width:17px;text-align:center;flex-shrink:0;}
.nav-badge.amber{background:var(--yellow);color:#1a0f00;}
#sidebar.collapsed .nav-badge{opacity:0;pointer-events:none;}
/* Footer */
.sb-footer{padding:10px 12px;border-top:1px solid var(--sb-border);display:flex;align-items:center;justify-content:center;gap:8px;flex-shrink:0;}
#sidebar.collapsed .sb-footer{justify-content:center;}
#sidebar.collapsed .sb-version{opacity:0;width:0;overflow:hidden;}
.sb-version{font-size:.6rem;color:var(--t3);font-family:'JetBrains Mono',monospace;white-space:nowrap;}
#sidebar.collapsed .sb-version{opacity:0;width:0;overflow:hidden;}
.theme-toggle{background:var(--surface2);border:1px solid var(--border);border-radius:24px;padding:3px;display:flex;gap:2px;flex-shrink:0;}
.theme-opt{width:30px;height:30px;border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:.85rem;transition:all .2s;cursor:pointer;border:none;background:none;}
.theme-opt.on{background:var(--blue);color:#fff;}
.theme-opt:not(.on){color:var(--t3);}
/* â•â•â• TOPBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#topbar{background:var(--topbar-bg);border-bottom:1px solid var(--topbar-border);padding:0 20px;height:58px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;transition:background .25s;gap:12px;}
.topbar-left{display:flex;align-items:center;gap:10px;min-width:0;}
.hamburger{background:none;border:none;cursor:pointer;color:var(--t2);padding:8px;border-radius:8px;font-size:1.3rem;display:none;transition:all .15s;flex-shrink:0;min-width:40px;min-height:40px;display:none;align-items:center;justify-content:center;}
.hamburger:hover{background:var(--surface2);color:var(--t1);}
.page-title{font-size:1.05rem;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;letter-spacing:-.01em;}
.topbar-right{display:flex;gap:8px;align-items:center;flex-shrink:0;}
/* â•â•â• PAGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#page-root{flex:1;overflow-y:auto;padding:20px 22px;transition:background .25s;}
/* â•â•â• BOTTOM NAV â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#bottom-nav{display:none;background:var(--topbar-bg);border-top:1px solid var(--topbar-border);padding:6px 0 calc(6px + env(safe-area-inset-bottom));flex-shrink:0;}
.bnav-inner{display:flex;justify-content:space-around;}
.bnav-btn{display:flex;flex-direction:column;align-items:center;gap:3px;padding:6px 8px;border-radius:8px;border:none;background:none;cursor:pointer;color:var(--t3);font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:.04em;transition:all .15s;position:relative;min-width:54px;}
.bnav-btn.active{color:var(--blue2);}
.bnav-btn.active .bnav-icon{background:var(--blue-dim);}
.bnav-icon{font-size:1.3rem;width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:9px;transition:background .15s;}
.bnav-dot{position:absolute;top:4px;right:8px;width:7px;height:7px;background:var(--red);border-radius:50%;border:2px solid var(--topbar-bg);}
/* â•â•â• PILLS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.pill{display:inline-flex;align-items:center;padding:4px 11px;border-radius:20px;font-size:.72rem;font-family:'JetBrains Mono',monospace;font-weight:600;letter-spacing:.03em;}
.pill-blue{background:var(--blue-dim);color:var(--blue2);}
.pill-green{background:var(--green-dim);color:var(--green);}
.pill-yellow{background:var(--yellow-dim);color:var(--yellow);}
.pill-red{background:var(--red-dim);color:var(--red);}
.pill-orange{background:var(--orange-dim);color:var(--orange);}
.pill-purple{background:var(--purple-dim);color:var(--purple);}
.pill-teal{background:var(--teal-dim);color:var(--teal);}
/* â•â•â• STAT CARDS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stats-row{display:grid;gap:10px;margin-bottom:18px;}
.stats-4{grid-template-columns:repeat(4,1fr);}
.stats-3{grid-template-columns:repeat(3,1fr);}
.stats-2{grid-template-columns:1fr 1fr;}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px 18px;position:relative;overflow:hidden;transition:background .25s,box-shadow .15s;}
.stat-card:hover{box-shadow:var(--shadow-sm);}
.stat-card.clickable{cursor:pointer;user-select:none;}
.stat-card.clickable:hover{box-shadow:var(--shadow);transform:translateY(-2px);border-color:var(--border2);}
.stat-card.clickable:active{transform:scale(.97);}
.stat-card-arrow{position:absolute;bottom:10px;right:12px;font-size:.7rem;color:var(--t3);opacity:.6;transition:opacity .15s,transform .15s;}
.stat-card.clickable:hover .stat-card-arrow{opacity:1;transform:translateX(2px);}
.stat-card::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;border-radius:0 0 10px 10px;}
.sc-blue::after{background:linear-gradient(90deg,var(--blue),#6366f1);}
.sc-green::after{background:var(--green);}
.sc-yellow::after{background:var(--yellow);}
.sc-red::after{background:var(--red);}
.sc-orange::after{background:var(--orange);}
.sc-purple::after{background:var(--purple);}
.sc-teal::after{background:var(--teal);}
.stat-lbl{font-size:.68rem;color:var(--t3);text-transform:uppercase;letter-spacing:.1em;font-family:'JetBrains Mono',monospace;margin-bottom:5px;font-weight:600;}
.stat-val{font-size:2.1rem;font-weight:800;line-height:1;letter-spacing:-.04em;}
.sv-blue{color:var(--blue2);}
.sv-green{color:var(--green);}
.sv-yellow{color:var(--yellow);}
.sv-red{color:var(--red);}
.sv-orange{color:var(--orange);}
.sv-purple{color:var(--purple);}
.sv-teal{color:var(--teal);}
.stat-sub{font-size:.72rem;color:var(--t3);margin-top:4px;}
/* â•â•â• BUTTONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn{display:inline-flex;align-items:center;gap:7px;padding:9px 16px;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:.88rem;font-weight:600;cursor:pointer;border:1px solid transparent;transition:all .15s;white-space:nowrap;text-decoration:none;line-height:1.2;min-height:38px;}
.btn:active{transform:scale(.97);}
.btn:disabled{opacity:.38;cursor:not-allowed;transform:none !important;}
.btn-pri{background:var(--blue);color:#fff;border-color:var(--blue);}
.btn-pri:hover:not(:disabled){background:#2563eb;box-shadow:0 4px 12px rgba(59,130,246,.35);}
.btn-sec{background:var(--surface2);color:var(--t1);border-color:var(--border);}
.btn-sec:hover:not(:disabled){background:var(--surface3);border-color:var(--border2);}
.btn-danger{background:var(--red-dim);color:var(--red);border-color:rgba(239,68,68,.3);}
.btn-danger:hover:not(:disabled){background:rgba(239,68,68,.2);}
.btn-success{background:var(--green-dim);color:var(--green);border-color:rgba(34,197,94,.3);}
.btn-success:hover:not(:disabled){background:rgba(34,197,94,.2);}
.btn-warn{background:var(--yellow-dim);color:var(--yellow);border-color:rgba(245,158,11,.3);}
.btn-warn:hover:not(:disabled){background:rgba(245,158,11,.2);}
.btn-teal{background:var(--teal-dim);color:var(--teal);border-color:rgba(20,184,166,.3);}
.btn-teal:hover:not(:disabled){background:rgba(20,184,166,.2);}
.btn-sm{padding:10px 17px;font-size:.88rem;min-height:32px;}
.btn-xs{padding:8px 13px;font-size:.82rem;border-radius:6px;min-height:28px;}
/* â•â•â• FORMS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.fg{margin-bottom:12px;}
.flbl{display:block;font-size:.71rem;color:var(--t2);margin-bottom:5px;font-family:'JetBrains Mono',monospace;text-transform:uppercase;letter-spacing:.07em;font-weight:600;}
.finput,.fsel,.ftxt{width:100%;background:var(--input-bg);border:1px solid var(--border);border-radius:8px;padding:10px 13px;color:var(--t1);font-family:'Plus Jakarta Sans',sans-serif;font-size:.9rem;outline:none;transition:border-color .15s,box-shadow .15s;min-height:42px;}
.finput:focus,.fsel:focus,.ftxt:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(59,130,246,.12);}
.fsel option{background:var(--input-bg);color:var(--t1);}
.ftxt{resize:vertical;min-height:72px;}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.frow3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;}
/* â•â•â• TABLE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tbl-wrap{overflow-x:auto;border-radius:9px;border:1px solid var(--border);}
table{width:100%;border-collapse:collapse;}
th{background:var(--surface2);padding:10px 13px;text-align:left;font-size:.76rem;font-family:'JetBrains Mono',monospace;text-transform:uppercase;letter-spacing:.09em;color:var(--t3);border-bottom:1px solid var(--border);white-space:nowrap;font-weight:600;}
td{padding:11px 13px;border-bottom:1px solid var(--border);font-size:.84rem;color:var(--t2);vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:var(--card-hover);}
/* â•â•â• MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-ov{position:fixed;inset:0;background:var(--modal-bg);backdrop-filter:blur(6px);z-index:200;display:flex;align-items:center;justify-content:center;padding:16px;animation:fadeIn .15s ease;}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal{background:var(--surface);border:1px solid var(--border2);border-radius:14px;width:100%;max-width:640px;max-height:92vh;overflow-y:auto;animation:slideUp .2s cubic-bezier(.4,0,.2,1);box-shadow:var(--shadow);}
.modal-wide{max-width:820px;}
.modal-xl{max-width:1000px;}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-hd{padding:16px 18px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--surface);z-index:1;border-radius:14px 14px 0 0;}
.modal-title{font-size:1.05rem;font-weight:800;}
.modal-body{padding:18px;}
.modal-ft{padding:12px 18px;border-top:1px solid var(--border);display:flex;gap:7px;justify-content:flex-end;position:sticky;bottom:0;background:var(--surface);border-radius:0 0 14px 14px;}
.modal-close{background:none;border:none;color:var(--t3);cursor:pointer;font-size:1.1rem;padding:4px;border-radius:5px;transition:all .15s;line-height:1;}
.modal-close:hover{color:var(--t1);background:var(--surface2);}
/* â•â•â• ALERTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.alert{padding:11px 14px;border-radius:8px;font-size:.84rem;margin-bottom:10px;line-height:1.6;display:flex;gap:9px;align-items:flex-start;}
.al-warn{background:var(--yellow-dim);border:1px solid rgba(245,158,11,.25);color:var(--yellow);}
.al-danger{background:var(--red-dim);border:1px solid rgba(239,68,68,.25);color:var(--red);}
.al-success{background:var(--green-dim);border:1px solid rgba(34,197,94,.25);color:var(--green);}
.al-info{background:var(--blue-dim);border:1px solid rgba(59,130,246,.25);color:var(--blue2);}
/* â•â•â• CARDS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px;transition:background .25s;}
.card-hd{font-size:.72rem;font-family:'JetBrains Mono',monospace;text-transform:uppercase;letter-spacing:.1em;color:var(--t3);margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;font-weight:700;}
.card-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);font-size:.84rem;}
.card-row:last-child{border-bottom:none;}
/* â•â•â• CHECKLIST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.cl-item{display:flex;align-items:flex-start;gap:12px;padding:13px 14px;border:1px solid var(--border);border-radius:9px;margin-bottom:6px;cursor:pointer;transition:all .15s;background:var(--surface2);}
.cl-item:hover{border-color:var(--border2);background:var(--surface3);}
.cl-item.ans-yes{border-color:rgba(34,197,94,.3);background:rgba(34,197,94,.06);}
.cl-item.ans-no{border-color:rgba(239,68,68,.3);background:rgba(239,68,68,.06);}
.cl-item.ans-na{border-color:rgba(139,92,246,.25);background:rgba(139,92,246,.05);}
.cl-num{font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--t3);min-width:22px;padding-top:2px;flex-shrink:0;}
.cl-text{flex:1;font-size:.88rem;line-height:1.6;padding-top:1px;}
.cl-sub{font-size:.68rem;color:var(--t3);margin-top:2px;}
.cl-btns{display:flex;gap:4px;flex-shrink:0;margin-top:1px;}
.cl-btn{padding:10px 16px;border-radius:6px;border:1px solid var(--border2);background:var(--surface3);color:var(--t2);font-size:.84rem;font-weight:700;cursor:pointer;transition:all .15s;font-family:'JetBrains Mono',monospace;min-height:34px;}
.cl-btn:hover{border-color:var(--border2);}
.cl-btn.sel-yes{background:var(--green-dim);border-color:rgba(34,197,94,.4);color:var(--green);}
.cl-btn.sel-no{background:var(--red-dim);border-color:rgba(239,68,68,.4);color:var(--red);}
.cl-btn.sel-na{background:var(--purple-dim);border-color:rgba(168,85,247,.4);color:var(--purple);}
.cl-remarks{width:100%;margin-top:6px;background:var(--input-bg);border:1px solid var(--border);border-radius:5px;padding:5px 8px;color:var(--t1);font-size:.72rem;font-family:'Plus Jakarta Sans',sans-serif;outline:none;resize:none;min-height:44px;transition:border-color .15s;}
.cl-remarks:focus{border-color:var(--blue);}
.cl-section{background:var(--surface3);border:1px solid var(--border);border-radius:7px;padding:8px 12px;margin-bottom:6px;font-size:.75rem;font-weight:700;color:var(--t2);letter-spacing:.02em;}
/* â•â•â• PROGRESS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.prog-wrap{margin-bottom:14px;}
.prog-meta{display:flex;align-items:center;justify-content:space-between;margin-bottom:5px;font-size:.71rem;color:var(--t3);}
.prog-bar{background:var(--surface3);border-radius:5px;height:6px;overflow:hidden;}
.prog-fill{height:100%;border-radius:5px;transition:width .5s cubic-bezier(.4,0,.2,1);}
/* â•â•â• TABS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:18px;gap:0;overflow-x:auto;scrollbar-width:none;}
.tabs::-webkit-scrollbar{display:none;}
.tab-btn{padding:12px 18px;font-size:.85rem;font-weight:600;color:var(--t3);border:none;background:none;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all .15s;white-space:nowrap;font-family:'Plus Jakarta Sans',sans-serif;flex-shrink:0;min-height:44px;}
.tab-btn:hover{color:var(--t2);}
.tab-btn.active{color:var(--blue2);border-bottom-color:var(--blue);}
/* â•â•â• SECTION HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sec-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px;}
.sec-title{font-size:1.05rem;font-weight:800;letter-spacing:-.01em;}
/* â•â•â• SEARCH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.search{background:var(--input-bg);border:1px solid var(--border);border-radius:7px;padding:7px 11px 7px 32px;color:var(--t1);font-size:.79rem;outline:none;transition:border-color .15s,box-shadow .15s;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%234a5278' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:9px center;background-size:15px;width:200px;}
.search:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(59,130,246,.12);}
/* â•â•â• EMPTY STATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:48px 20px;color:var(--t3);text-align:center;gap:7px;}
.empty-icon{font-size:2.5rem;opacity:.3;}
/* â•â•â• CHART CANVAS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.chart-wrap{position:relative;width:100%;background:var(--surface2);border-radius:8px;overflow:hidden;}
canvas{display:block;}
/* â•â•â• STAFF BADGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.staff-badge{display:inline-flex;align-items:center;gap:5px;background:var(--teal-dim);border:1px solid rgba(20,184,166,.3);border-radius:20px;padding:3px 10px;font-size:.68rem;color:var(--teal);font-family:'JetBrains Mono',monospace;}
/* â•â•â• SIGN IN BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#signin-bar{background:var(--blue-dim);border-bottom:1px solid rgba(59,130,246,.25);padding:8px 22px;display:flex;align-items:center;gap:10px;font-size:.82rem;flex-shrink:0;}
#signin-bar .sb-label{color:var(--blue2);font-weight:600;}
#signin-bar select{background:var(--input-bg);border:1px solid rgba(59,130,246,.3);border-radius:7px;padding:6px 12px;color:var(--t1);font-size:.82rem;outline:none;font-family:'Plus Jakarta Sans',sans-serif;min-height:34px;}
/* â•â•â• FACILITY SELECTOR CARDS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.facility-cards-wrap{padding:8px 10px 10px;border-bottom:1px solid var(--sb-border);}
#sidebar.collapsed .facility-cards-wrap{display:none;}
.facility-label-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;}
.facility-label{font-size:.58rem;font-family:'JetBrains Mono',monospace;text-transform:uppercase;letter-spacing:.1em;color:var(--t3);}
.fac-cards{display:flex;flex-direction:column;gap:4px;}
.fac-card{min-height:40px;
  display:flex;align-items:center;gap:10px;
  padding:10px 12px;border-radius:9px;
  border:1.5px solid var(--border);
  background:var(--surface2);
  cursor:pointer;width:100%;text-align:left;
  transition:all .18s cubic-bezier(.4,0,.2,1);
  position:relative;overflow:hidden;
  min-height:44px;
}
.fac-card:hover{border-color:var(--border2);background:var(--surface3);}
.fac-card-dot{
  width:9px;height:9px;border-radius:50%;flex-shrink:0;
  border:2px solid var(--border2);
  transition:all .18s;
}
.fac-card-inner{display:flex;align-items:center;justify-content:space-between;flex:1;}
.fac-card-id{font-size:.85rem;font-weight:700;font-family:'JetBrains Mono',monospace;letter-spacing:.02em;color:var(--t2);transition:color .18s;}
.fac-card-check{font-size:.7rem;opacity:0;transform:scale(0.5);transition:all .18s;margin-left:4px;}

/* T11C01 = BLUE */
.fac-card-T11C01:hover .fac-card-dot{border-color:var(--blue);background:rgba(59,130,246,.3);}
.fac-card-T11C01.active{
  border-color:rgba(59,130,246,.6) !important;
  background:rgba(59,130,246,.14) !important;
  box-shadow:0 0 0 1px rgba(59,130,246,.2),inset 0 0 12px rgba(59,130,246,.08);
}
.fac-card-T11C01.active .fac-card-dot{border-color:var(--blue);background:var(--blue);box-shadow:0 0 6px rgba(59,130,246,.6);}
.fac-card-T11C01.active .fac-card-id{color:var(--blue2);}
.fac-card-T11C01.active .fac-card-check{opacity:1;transform:scale(1);color:var(--blue2);}
.fac-card-T11C01.active::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--blue);border-radius:8px 0 0 8px;}

/* T1442 = GREEN */
.fac-card-T1442:hover .fac-card-dot{border-color:var(--green);background:rgba(34,197,94,.3);}
.fac-card-T1442.active{
  border-color:rgba(34,197,94,.6) !important;
  background:rgba(34,197,94,.14) !important;
  box-shadow:0 0 0 1px rgba(34,197,94,.2),inset 0 0 12px rgba(34,197,94,.08);
}
.fac-card-T1442.active .fac-card-dot{border-color:var(--green);background:var(--green);box-shadow:0 0 6px rgba(34,197,94,.6);}
.fac-card-T1442.active .fac-card-id{color:#4ade80;}
.fac-card-T1442.active .fac-card-check{opacity:1;transform:scale(1);color:#4ade80;}
.fac-card-T1442.active::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--green);border-radius:8px 0 0 8px;}

/* Makerspace = RED */
.fac-card-Makerspace:hover .fac-card-dot{border-color:var(--red);background:rgba(239,68,68,.3);}
.fac-card-Makerspace.active{
  border-color:rgba(239,68,68,.6) !important;
  background:rgba(239,68,68,.14) !important;
  box-shadow:0 0 0 1px rgba(239,68,68,.2),inset 0 0 12px rgba(239,68,68,.08);
}
.fac-card-Makerspace.active .fac-card-dot{border-color:var(--red);background:var(--red);box-shadow:0 0 6px rgba(239,68,68,.6);}
.fac-card-Makerspace.active .fac-card-id{color:#f87171;}
.fac-card-Makerspace.active .fac-card-check{opacity:1;transform:scale(1);color:#f87171;}
.fac-card-Makerspace.active::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--red);border-radius:8px 0 0 8px;}

/* â•â•â• FACILITY TAG â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.fac-tag{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:5px;font-size:.63rem;font-family:'JetBrains Mono',monospace;font-weight:600;}
.fac-T11C01{background:rgba(59,130,246,.15);color:var(--blue2);}
.fac-T1442{background:rgba(34,197,94,.15);color:var(--green);}
.fac-Makerspace{background:rgba(239,68,68,.15);color:var(--red);}

/* â•â•â• FACILITY ACCENT â€” applied via data-facility on <html> â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* Default / T11C01 = BLUE */
:root,[data-facility="T11C01"]{
  --fac:var(--blue);--fac2:var(--blue2);
  --fac-dim:rgba(59,130,246,0.13);--fac-border:rgba(59,130,246,0.28);
  --fac-glow:rgba(59,130,246,0.22);--fac-gradient:linear-gradient(135deg,rgba(59,130,246,0.13),rgba(99,102,241,0.09));
}
/* T1442 = GREEN */
[data-facility="T1442"]{
  --fac:var(--green);--fac2:#4ade80;
  --fac-dim:rgba(34,197,94,0.13);--fac-border:rgba(34,197,94,0.28);
  --fac-glow:rgba(34,197,94,0.22);--fac-gradient:linear-gradient(135deg,rgba(34,197,94,0.13),rgba(16,185,129,0.09));
}
/* Makerspace = RED */
[data-facility="Makerspace"]{
  --fac:var(--red);--fac2:#f87171;
  --fac-dim:rgba(239,68,68,0.13);--fac-border:rgba(239,68,68,0.28);
  --fac-glow:rgba(239,68,68,0.22);--fac-gradient:linear-gradient(135deg,rgba(239,68,68,0.13),rgba(249,115,22,0.09));
}
/* Apply accent to UI chrome */
#sidebar{position:relative;transition:width .3s cubic-bezier(.4,0,.2,1),background .25s;}
#sidebar::after{content:'';position:absolute;top:0;right:-1px;width:3px;height:100%;background:var(--fac);opacity:.8;pointer-events:none;border-radius:2px;transition:background .35s;}
#topbar{border-bottom:2px solid var(--fac-border) !important;transition:border-color .35s,background .25s;}
#signin-bar{background:var(--fac-dim) !important;border-bottom-color:var(--fac-border) !important;}
#signin-bar .sb-label{color:var(--fac2) !important;}
#signin-bar select{border-color:var(--fac-border) !important;}
.nav-btn.active{background:var(--fac-dim) !important;color:var(--fac2) !important;}
.nav-btn.active::before{background:var(--fac) !important;}
.theme-opt.on{background:var(--fac) !important;}
.tab-btn.active{color:var(--fac2) !important;border-bottom-color:var(--fac) !important;}
.btn-pri{background:var(--fac) !important;border-color:var(--fac) !important;}
.btn-pri:hover:not(:disabled){filter:brightness(0.87);box-shadow:0 4px 14px var(--fac-glow) !important;}
.cl-form-banner{background:var(--fac-gradient) !important;border-color:var(--fac-border) !important;}
.cl-form-title{color:var(--fac2) !important;}
.bnav-btn.active{color:var(--fac2) !important;}
.bnav-btn.active .bnav-icon{background:var(--fac-dim) !important;}
.facility-sel-wrap{border-bottom:1px solid var(--fac-border) !important;}
.finput:focus,.fsel:focus,.ftxt:focus,.search:focus{border-color:var(--fac) !important;box-shadow:0 0 0 3px var(--fac-dim) !important;}
/* Topbar facility badge */
.topbar-fac-badge{
  display:inline-flex;align-items:center;gap:8px;
  padding:6px 14px 6px 10px;border-radius:9px;
  font-family:'JetBrains Mono',monospace;font-size:.82rem;font-weight:800;letter-spacing:.04em;
  border:1.5px solid var(--fac-border);
  background:var(--fac-dim);
  color:var(--fac2);
  transition:all .25s;
  cursor:default;
  user-select:none;
}
.topbar-fac-dot{
  width:8px;height:8px;border-radius:50%;
  background:var(--fac);
  box-shadow:0 0 6px var(--fac-glow);
  animation:fac-pulse 2s ease-in-out infinite;
  flex-shrink:0;
}
@keyframes fac-pulse{
  0%,100%{box-shadow:0 0 4px var(--fac-glow);}
  50%{box-shadow:0 0 10px var(--fac),0 0 16px var(--fac-glow);}
}
/* Keep old #topbar-fac-tag rule for backward compat but it now targets the badge */
#topbar-fac-tag{background:var(--fac-dim) !important;color:var(--fac2) !important;border:1.5px solid var(--fac-border) !important;}


/* â•â•â• PHOTO UPLOAD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.photo-upload-wrap{margin-bottom:12px;}
.photo-preview{
  width:100%;height:160px;border-radius:9px;border:2px dashed var(--border2);
  background:var(--surface2);display:flex;flex-direction:column;align-items:center;
  justify-content:center;gap:6px;cursor:pointer;transition:all .18s;overflow:hidden;
  position:relative;
}
.photo-preview:hover{border-color:var(--fac);background:var(--fac-dim);}
.photo-preview img{width:100%;height:100%;object-fit:cover;border-radius:7px;}
.photo-preview .photo-placeholder{display:flex;flex-direction:column;align-items:center;gap:5px;pointer-events:none;}
.photo-placeholder-icon{font-size:2rem;opacity:.4;}
.photo-placeholder-lbl{font-size:.78rem;color:var(--t3);font-weight:500;}
.photo-placeholder-sub{font-size:.68rem;color:var(--t3);opacity:.7;}
.photo-actions{display:flex;gap:7px;margin-top:7px;flex-wrap:wrap;}
.photo-clear{position:absolute;top:6px;right:6px;background:rgba(0,0,0,.55);color:#fff;border:none;border-radius:50%;width:26px;height:26px;font-size:.75rem;cursor:pointer;display:none;align-items:center;justify-content:center;z-index:2;transition:background .15s;}
.photo-clear:hover{background:rgba(239,68,68,.8);}
.photo-preview.has-photo .photo-clear{display:flex;}
.photo-preview.has-photo .photo-placeholder{display:none;}

/* â•â•â• PREDICTIVE CARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.pred-bar{height:8px;border-radius:4px;background:var(--surface3);overflow:hidden;margin-top:4px;}
.pred-fill{height:100%;border-radius:4px;transition:width .6s cubic-bezier(.4,0,.2,1);}
/* â•â•â• RESPONSIVE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:1100px){.stats-4{grid-template-columns:repeat(2,1fr);}}
@media(max-width:900px){
  #sidebar{width:64px;}
  #sidebar .nav-section,#sidebar .nav-lbl,#sidebar .sb-version,#sidebar .logo-text,#sidebar .facility-sel-wrap{opacity:0;width:0;overflow:hidden;padding:0;height:0;}
  #sidebar .nav-btn{justify-content:center;padding:10px;}
  #sidebar .logo-wrap{justify-content:center;}
  #sidebar .sb-collapse-btn{display:none;}
  #sidebar .sb-footer{justify-content:center;}
  #topbar{padding:0 14px;}
  #page-root{padding:14px;}
  #signin-bar{padding:6px 14px;}
  /* When mobile overlay is open, restore full sidebar appearance */
  #sidebar.mobile-open .nav-section{opacity:1 !important;width:auto !important;height:auto !important;padding:10px 8px 4px !important;overflow:visible !important;}
  #sidebar.mobile-open .nav-lbl{opacity:1 !important;width:auto !important;overflow:visible !important;}
  #sidebar.mobile-open .sb-version{opacity:1 !important;width:auto !important;overflow:visible !important;}
  #sidebar.mobile-open .logo-text{opacity:1 !important;width:auto !important;overflow:visible !important;}
  #sidebar.mobile-open .facility-cards-wrap{display:block !important;opacity:1 !important;width:auto !important;height:auto !important;overflow:visible !important;padding:8px 10px 10px !important;}
  #sidebar.mobile-open .nav-btn{justify-content:flex-start !important;padding:10px 10px !important;}
  #sidebar.mobile-open .logo-wrap{justify-content:flex-start !important;}
  #sidebar.mobile-open .sb-footer{justify-content:space-between !important;}
  #sidebar.mobile-open .nav-badge{opacity:1 !important;pointer-events:auto !important;}
}
@media(max-width:700px){
  #sidebar{display:none;}
  #bottom-nav{display:block;}
  #topbar{height:58px;padding:0 14px;}
  .hamburger{display:flex !important;font-size:1.3rem;padding:8px 6px;}
  .page-title{font-size:1rem;font-weight:700;}
  #page-root{padding:14px 14px 86px;}
  .stats-4,.stats-3{grid-template-columns:1fr 1fr;}
  .frow,.frow3{grid-template-columns:1fr;}
  .g2{grid-template-columns:1fr;}
  .search{width:130px;}
  .modal{border-radius:18px 18px 0 0;}
  .modal-ov{align-items:flex-end;padding:0;}
  .modal{max-height:92vh;}
  #signin-bar{padding:8px 14px;gap:8px;}
  #signin-bar .sb-label{white-space:nowrap;font-size:.84rem;}
  #signin-bar select{flex:1;min-width:0;font-size:.86rem;padding:8px 12px;}
  #signin-time{display:none !important;}
  #topbar-date{display:none !important;}
  .topbar-fac-badge{font-size:.78rem;padding:6px 11px 6px 9px;}
  .theme-opt{width:30px;height:30px;}
  .cl-form-banner{flex-direction:column;align-items:flex-start;}
  .cl-form-banner > div:last-child{display:flex;flex-wrap:wrap;gap:6px;width:100%;}
  .cl-form-banner .btn{flex:1;justify-content:center;min-width:72px;}
  #bottom-nav{padding:8px 0 calc(8px + env(safe-area-inset-bottom));}
  .bnav-inner{padding:0 4px;}
  .bnav-btn{font-size:.62rem;min-width:52px;}
  td,th{font-size:.82rem;}
}
@media(max-width:420px){
  .stats-4,.stats-3,.stats-2{grid-template-columns:1fr;}
  #page-root{padding:10px 10px 86px;}
  .page-title{font-size:.92rem;}
  #signin-bar{padding:7px 10px;}
  .topbar-fac-badge{font-size:.72rem;padding:5px 9px 5px 7px;}
}
  #page-root{padding:12px 12px 86px;}
  .page-title{font-size:1.05rem;}
}
#mobile-sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:100;}
#sidebar.mobile-open{display:flex !important;position:fixed;top:0;left:0;height:100dvh;z-index:101;width:240px !important;}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
/* Checklist form header banner */
.cl-form-banner{background:linear-gradient(135deg,rgba(59,130,246,.12),rgba(99,102,241,.12));border:1px solid rgba(59,130,246,.25);border-radius:10px;padding:14px 16px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;}
.cl-form-title{font-size:1rem;font-weight:800;letter-spacing:-.02em;}
.cl-form-meta{font-size:.71rem;color:var(--t3);margin-top:2px;}
/* Radio styled as toggle strip */
.yn-strip{display:inline-flex;border:1px solid var(--border2);border-radius:6px;overflow:hidden;}
.yn-strip button{padding:5px 11px;font-size:.67rem;font-family:'JetBrains Mono',monospace;font-weight:600;border:none;cursor:pointer;background:none;color:var(--t3);transition:all .15s;}
.yn-strip button:not(:last-child){border-right:1px solid var(--border2);}
.yn-strip button.on-yes{background:var(--green-dim);color:var(--green);}
.yn-strip button.on-no{background:var(--red-dim);color:var(--red);}
.yn-strip button.on-na{background:var(--purple-dim);color:var(--purple);}
/* Audit log row */
.log-row{display:flex;gap:8px;padding:7px 0;border-bottom:1px solid var(--border);font-size:.73rem;align-items:flex-start;}
.log-row:last-child{border-bottom:none;}
.log-time{font-family:'JetBrains Mono',monospace;color:var(--t3);font-size:.67rem;white-space:nowrap;min-width:120px;}
.log-who{color:var(--blue2);font-weight:600;min-width:90px;}
.log-what{color:var(--t2);flex:1;}
/* Equipment usage sparkline */
.sparkline-wrap{display:flex;align-items:flex-end;gap:2px;height:32px;}
.spark-bar{flex:1;background:var(--blue-dim);border-radius:2px 2px 0 0;transition:height .3s,background .15s;min-width:6px;}
.spark-bar:hover{background:var(--blue);}
</style>
</head>
<body>
<div id="app">
  <!-- SIDEBAR -->
  <div id="sidebar">
    <div class="sb-header">
      <div class="logo-wrap">
        <div class="logo-icon">ğŸ—ï¸</div>
        <div class="logo-text">
          <div class="logo-name">Fablab <em>Facility</em></div>
          <div class="logo-sub">Handy Platform</div>
        </div>
      </div>
      <button class="sb-collapse-btn" onclick="toggleSidebar()">âŸ¨</button>
    </div>
    <!-- Facility Selector Cards -->
    <div class="facility-cards-wrap" id="facility-cards-wrap">
      <div class="facility-label-row">
        <span class="facility-label">Active Facility</span>
      </div>
      <div class="fac-cards" id="fac-cards">
        <button class="fac-card fac-card-T11C01 active" id="fac-card-T11C01" onclick="switchFacility('T11C01')">
          <span class="fac-card-dot"></span>
          <div class="fac-card-inner">
            <span class="fac-card-id">T11C01</span>
            <span class="fac-card-check">âœ“</span>
          </div>
        </button>
        <button class="fac-card fac-card-T1442" id="fac-card-T1442" onclick="switchFacility('T1442')">
          <span class="fac-card-dot"></span>
          <div class="fac-card-inner">
            <span class="fac-card-id">T1442</span>
            <span class="fac-card-check">âœ“</span>
          </div>
        </button>
        <button class="fac-card fac-card-Makerspace" id="fac-card-Makerspace" onclick="switchFacility('Makerspace')">
          <span class="fac-card-dot"></span>
          <div class="fac-card-inner">
            <span class="fac-card-id">Makerspace</span>
            <span class="fac-card-check">âœ“</span>
          </div>
        </button>
      </div>
    </div>
    <!-- Hidden select kept for JS compatibility -->
    <select id="facility-select" style="display:none" onchange="switchFacility(this.value)">
      <option value="T11C01">T11C01</option>
      <option value="T1442">T1442</option>
      <option value="Makerspace">Makerspace</option>
    </select>
    <nav class="nav">
      <div class="nav-section">Main</div>
      <button class="nav-btn active" onclick="navigate('dashboard')" id="nav-dashboard"><span class="nav-icon">âš¡</span><span class="nav-lbl">Dashboard</span></button>
      <!-- Asset Management with sub-nav -->
      <button class="nav-btn" onclick="toggleSubNav('assets-sub');navigate('assets')" id="nav-assets"><span class="nav-icon">ğŸ·ï¸</span><span class="nav-lbl">Asset Management</span><span class="nav-lbl nav-sub-arrow" id="assets-sub-arrow" style="flex:0;margin-left:auto;font-size:.7rem;transition:transform .2s">â€º</span></button>
      <div class="sub-nav" id="assets-sub">
        <button class="nav-btn nav-sub" onclick="navigate('assets');setAssetFilter('all')" id="nav-assets-all"><span class="nav-icon">ğŸ“‹</span><span class="nav-lbl">All Assets</span></button>
        <button class="nav-btn nav-sub" onclick="navigate('assets');setAssetFilter('Fixed Asset')" id="nav-assets-fa"><span class="nav-icon">ğŸ—ï¸</span><span class="nav-lbl">Fixed Assets</span></button>
        <button class="nav-btn nav-sub" onclick="navigate('assets');setAssetFilter('LVA')" id="nav-assets-lva"><span class="nav-icon">ğŸ“¦</span><span class="nav-lbl">Low Value Assets</span></button>
      </div>
      <div class="nav-section">Safety & Checks</div>
      <button class="nav-btn" onclick="navigate('wsh-daily')" id="nav-wsh-daily"><span class="nav-icon">ğŸ“…</span><span class="nav-lbl">Daily Checklist</span><span class="nav-badge" id="badge-daily" style="display:none">!</span></button>
      <button class="nav-btn" onclick="navigate('wsh-monthly')" id="nav-wsh-monthly"><span class="nav-icon">ğŸ“†</span><span class="nav-lbl">Monthly Checklist</span></button>
      <button class="nav-btn" onclick="navigate('wsh-yearly')" id="nav-wsh-yearly"><span class="nav-icon">ğŸ“Š</span><span class="nav-lbl">Hazard Checklist</span></button>
      <button class="nav-btn" onclick="navigate('firstaid')" id="nav-firstaid"><span class="nav-icon">ğŸ©¹</span><span class="nav-lbl">First Aid</span><span class="nav-badge amber" id="badge-fa" style="display:none">!</span></button>
      <button class="nav-btn" onclick="navigate('chemicals')" id="nav-chemicals"><span class="nav-icon">ğŸ§ª</span><span class="nav-lbl">Chemicals SDS</span></button>
      <div class="nav-section">Operations</div>
      <button class="nav-btn" onclick="navigate('maintenance')" id="nav-maintenance"><span class="nav-icon">ğŸ”§</span><span class="nav-lbl">Maintenance</span><span class="nav-badge" id="badge-maint" style="display:none">!</span></button>
      <button class="nav-btn" onclick="navigate('analytics')" id="nav-analytics"><span class="nav-icon">ğŸ“ˆ</span><span class="nav-lbl">Analytics & PPM</span></button>
      <div class="nav-section">Admin</div>
      <button class="nav-btn" onclick="navigate('staff')" id="nav-staff"><span class="nav-icon">ğŸ‘¥</span><span class="nav-lbl">Staff Management</span></button>
      <button class="nav-btn" onclick="navigate('facilities')" id="nav-facilities"><span class="nav-icon">ğŸ¢</span><span class="nav-lbl">Facilities Admin</span></button>
      <button class="nav-btn" onclick="navigate('passcodes')" id="nav-passcodes"><span class="nav-icon">ğŸ”</span><span class="nav-lbl">Passcode Records</span></button>
      <button class="nav-btn" onclick="navigate('auditlog')" id="nav-auditlog"><span class="nav-icon">ğŸ“‹</span><span class="nav-lbl">Audit Log</span></button>
    </nav>
    <div class="sb-footer">
      <span class="sb-version">v1.0 Â· Fablab Facility</span>
    </div>
  </div>

  <!-- MAIN -->
  <div id="main">
    <!-- SIGN-IN BAR -->
    <div id="signin-bar">
      <span class="sb-label">Signed in as:</span>
      <select id="staff-select" onchange="switchStaff(this.value)">
        <option value="">â€” Select staff â€”</option>
      </select>
      <span id="signin-time" style="color:var(--t3);font-family:'JetBrains Mono',monospace;font-size:.67rem;margin-left:auto;"></span>
    </div>
    <!-- TOPBAR -->
    <div id="topbar">
      <div class="topbar-left">
        <button class="hamburger" onclick="openMobileSidebar()">â˜°</button>
        <div class="page-title" id="page-title">Dashboard</div>
      </div>
      <div class="topbar-right" id="topbar-right">
        <div class="theme-toggle" id="topbar-theme-toggle">
          <button class="theme-opt on" id="theme-dark" onclick="setTheme('dark')" title="Dark mode">ğŸŒ™</button>
          <button class="theme-opt" id="theme-light" onclick="setTheme('light')" title="Light mode">â˜€ï¸</button>
        </div>
        <div id="topbar-fac-display">
          <span class="topbar-fac-badge fac-T11C01" id="topbar-fac-tag">
            <span class="topbar-fac-dot" id="topbar-fac-dot"></span>
            <span id="topbar-fac-name">T11C01</span>
          </span>
        </div>
        <span class="pill pill-blue" id="topbar-date"></span>
      </div>
    </div>
    <!-- PAGE -->
    <div id="page-root"></div>
    <!-- BOTTOM NAV -->
    <div id="bottom-nav">
      <div class="bnav-inner">
        <button class="bnav-btn active" onclick="navigate('dashboard')" id="bnav-dashboard"><span class="bnav-icon">âš¡</span><span>Home</span></button>
        <button class="bnav-btn" onclick="navigate('assets')" id="bnav-assets"><span class="bnav-icon">ğŸ·ï¸</span><span>Assets</span></button>
        <button class="bnav-btn" onclick="navigate('wsh-daily')" id="bnav-wsh-daily"><span class="bnav-icon">ğŸ“…</span><span>Daily</span><span class="bnav-dot" id="bnav-dot-daily" style="display:none"></span></button>
        <button class="bnav-btn" onclick="navigate('maintenance')" id="bnav-maintenance"><span class="bnav-icon">ğŸ”§</span><span>Maint.</span><span class="bnav-dot" id="bnav-dot-maint" style="display:none"></span></button>
        <button class="bnav-btn" onclick="navigate('analytics')" id="bnav-analytics"><span class="bnav-icon">ğŸ“ˆ</span><span>Analytics</span></button>
      </div>
    </div>
  </div>
</div>

<div id="mobile-sidebar-overlay" onclick="closeMobileSidebar()"></div>
<div id="modal-container"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CORE STATE & THEME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentTheme = localStorage.getItem('fos-theme') || 'dark';
function setTheme(t){
  currentTheme=t; document.documentElement.setAttribute('data-theme',t);
  localStorage.setItem('fos-theme',t);
  ['theme-dark','theme-light'].forEach(id=>{const el=document.getElementById(id);if(el)el.className='theme-opt'+(el.id.includes(t)?' on':'');});
}
setTheme(currentTheme);

let sbCollapsed=false;
function toggleSidebar(){
  sbCollapsed=!sbCollapsed;
  document.getElementById('sidebar').classList.toggle('collapsed',sbCollapsed);
  document.querySelector('.sb-collapse-btn').textContent=sbCollapsed?'âŸ©':'âŸ¨';
}
function openMobileSidebar(){
  document.getElementById('sidebar').classList.add('mobile-open');
  document.getElementById('mobile-sidebar-overlay').style.display='block';
}
function closeMobileSidebar(){
  document.getElementById('sidebar').classList.remove('mobile-open');
  document.getElementById('mobile-sidebar-overlay').style.display='none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA MODEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FACILITIES_DEFAULT = ['T11C01','T1442','Makerspace'];

let DB = {
  // Facilities
  facilities: [
    {id:'T11C01', name:'T11C01', active:true, color:'blue'},
    {id:'T1442', name:'T1442', active:true, color:'teal'},
    {id:'Makerspace', name:'Makerspace', active:true, color:'purple'},
  ],
  // Staff list
  staff: [
    {id:'s1', name:'Yeo Gau Siong',   role:'Senior Technical Executive', active:true},
    {id:'s2', name:'Chaik Haw Ren',   role:'Senior Technical Executive', active:true},
    {id:'s3', name:'Florimond Chu',   role:'Lead Technical Executive',   active:true},
    {id:'s4', name:'Mark Ng',         role:'Manager',                    active:true},
  ],
  // Assets (per facility)
  assets: [],
  // WSH Checklist State (keyed by facilityId + period + date)
  wshChecks: {},
  // WSH History
  wshHistory: [],
  // First Aid (per facility)
  firstAid: {},
  // Maintenance records
  maintenance: [],
  // Contracts
  contracts: [],
  // Equipment usage log (for predictive maintenance)
  usageLog: [],
  // PPM Settings per asset
  ppmSettings: {},
  // Teams webhook
  teamsWebhook: '',
  // Floor plans
  floorplans: {},
  // Audit log
  auditLog: [],
  // Chemicals SDS
  chemicals: {},
  // Passcode records (stored encrypted)
  passcodes: [],
};

// Current state
let currentFacility = 'T11C01';
let currentStaff = null; // {id, name, role}
let currentPage = 'dashboard';
let assetView='list', assetSearch='', assetFilter='All';
let maintTab='upcoming';
let wshTab='checklist'; // checklist / history

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function dbLoad(){
  if(!window.storage)return;
  try{const r=await window.storage.get('fablab-v1');if(r)Object.assign(DB,JSON.parse(r.value));}catch(e){}
}
async function dbSave(){
  if(!window.storage)return;
  try{await window.storage.set('fablab-v1',JSON.stringify(DB));}catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUDIT LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function auditLog(action, details=''){
  const rec={
    id:'al'+Date.now(),
    ts:new Date().toISOString(),
    staff:currentStaff?.name||'System',
    facility:currentFacility,
    action, details
  };
  DB.auditLog=[rec,...DB.auditLog].slice(0,500);
  dbSave();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STAFF MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchStaff(id){
  const s=DB.staff.find(x=>x.id===id);
  currentStaff=s||null;
  const t=document.getElementById('signin-time');
  if(t) t.textContent=s?new Date().toLocaleString('en-SG'):'';
  if(s) auditLog('Signed in','Staff logged in');
}

function populateStaffSelect(){
  const sel=document.getElementById('staff-select');
  if(!sel)return;
  const prev=sel.value;
  sel.innerHTML='<option value="">â€” Select staff â€”</option>';
  DB.staff.filter(s=>s.active).forEach(s=>{
    const o=document.createElement('option');
    o.value=s.id; o.textContent=`${s.name} (${s.role})`;
    if(currentStaff&&currentStaff.id===s.id)o.selected=true;
    sel.appendChild(o);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FACILITY MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchFacility(id){
  if(!DB.facilities.find(f=>f.id===id&&f.active)){alert('Facility is inactive.');return;}
  currentFacility=id;
  // Apply facility colour theme to whole page
  document.documentElement.setAttribute('data-facility',id);
  // Update sidebar card active states
  ['T11C01','T1442','Makerspace'].forEach(fid=>{
    const c=document.getElementById('fac-card-'+fid);
    if(c)c.classList.toggle('active',fid===id);
  });
  const tag=document.getElementById('topbar-fac-tag');
  if(tag){tag.className=`topbar-fac-badge fac-${id}`;}
  const tagName=document.getElementById('topbar-fac-name');
  if(tagName)tagName.textContent=id;
  const facSel=document.getElementById('facility-select');
  if(facSel)facSel.value=id;
  auditLog('Switched facility','Now viewing '+id);
  updateBadges();
  navigate(currentPage);
}

function populateFacilitySelect(){
  // Update hidden select
  const sel=document.getElementById('facility-select');
  if(sel){
    sel.innerHTML='';
    DB.facilities.filter(f=>f.active).forEach(f=>{
      const o=document.createElement('option');
      o.value=f.id; o.textContent=f.name;
      if(f.id===currentFacility)o.selected=true;
      sel.appendChild(o);
    });
  }
  // Update card active states â€” show/hide cards based on active facilities
  DB.facilities.forEach(f=>{
    const card=document.getElementById('fac-card-'+f.id);
    if(card){
      card.style.display=f.active?'flex':'none';
      card.classList.toggle('active',f.id===currentFacility);
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function daysUntil(d){if(!d)return 9999;return Math.ceil((new Date(d)-new Date())/86400000);}
function fmtDate(d){if(!d)return'â€”';return new Date(d).toLocaleDateString('en-SG',{day:'2-digit',month:'short',year:'numeric'});}
function fmtDateTime(d){if(!d)return'â€”';return new Date(d).toLocaleString('en-SG',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'});}
function fmtMoney(n){return Number(n||0).toLocaleString('en-SG',{style:'currency',currency:'SGD',maximumFractionDigits:0});}
function downtimeStr(iso){if(!iso)return'â€”';const s=Math.floor((Date.now()-new Date(iso))/1000);return`${Math.floor(s/86400)}d ${Math.floor((s%86400)/3600)}h ${Math.floor((s%3600)/60)}m`;}
function statusColor(s){return{Active:'green','Under Maintenance':'yellow',Faulty:'red',Disposed:'purple',Withdrawn:'orange'}[s]||'blue';}
function faStatus(item){const d=daysUntil(item.expiry);if(item.qty===0||d<=0)return'Critical';if(d<=60)return'Expiring';if(item.qty<item.minQty)return'Low';return'OK';}
function faColor(s){return{OK:'green',Low:'yellow',Expiring:'orange',Critical:'red'}[s]||'blue';}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function todayStr(){return new Date().toISOString().slice(0,10);}
function monthKey(){const d=new Date();return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;}
function yearKey(){return String(new Date().getFullYear());}
function requireStaff(){if(!currentStaff){alert('Please select your name from the sign-in bar before proceeding.');return false;}return true;}
function facAssets(){return DB.assets.filter(a=>a.facility===currentFacility);}
function facFirstAid(){return(DB.firstAid[currentFacility]||[]);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ROUTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function navigate(page){
  currentPage=page;
  closeMobileSidebar();
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.bnav-btn').forEach(b=>b.classList.remove('active'));
  const nb=document.getElementById('nav-'+page);
  if(nb)nb.classList.add('active');
  const bb=document.getElementById('bnav-'+page);
  if(bb)bb.classList.add('active');
  const titles={
    dashboard:'Operations Dashboard',assets:'Asset Management',
    'wsh-daily':'Daily Safety Checklist','wsh-monthly':'Monthly Safety Checklist',
    'wsh-yearly':'Hazard Identification Checklist',
    firstaid:'First Aid Inventory',maintenance:'Maintenance & Downtime',
    analytics:'Analytics & Predictive PPM',staff:'Staff Management',
    facilities:'Facilities Administration',auditlog:'Audit Log',
    chemicals:'Chemicals Safety Data Sheet',passcodes:'Passcode Records'
  };
  document.getElementById('page-title').textContent=titles[page]||page;
  updateBadges();
  const root=document.getElementById('page-root');
  root.innerHTML='';root.scrollTop=0;
  if(page==='dashboard')renderDashboard(root);
  else if(page==='assets')renderAssets(root);
  else if(page==='wsh-daily')renderWSH(root,'daily');
  else if(page==='wsh-monthly')renderWSH(root,'monthly');
  else if(page==='wsh-yearly')renderWSH(root,'yearly');
  else if(page==='firstaid')renderFirstAid(root);
  else if(page==='maintenance')renderMaintenance(root);
  else if(page==='analytics')renderAnalytics(root);
  else if(page==='staff')renderStaff(root);
  else if(page==='facilities')renderFacilitiesAdmin(root);
  else if(page==='auditlog')renderAuditLog(root);
  else if(page==='chemicals')renderChemicals(root);
  else if(page==='passcodes')renderPasscodes(root);
}

function updateBadges(){
  const fAssets=facAssets();
  const faulty=fAssets.filter(a=>a.status==='Faulty').length;
  const mDue=fAssets.filter(a=>a.maintenanceDate&&daysUntil(a.maintenanceDate)<=30).length;
  const fa=facFirstAid().filter(i=>faStatus(i)!=='OK').length;
  // today's daily not submitted
  const dailyKey=`${currentFacility}-daily-${todayStr()}`;
  const dailyDone=DB.wshChecks[dailyKey]?.submitted;
  ['badge-daily'].forEach(id=>{const el=document.getElementById(id);if(el){el.textContent='!';el.style.display=!dailyDone?'':'none';}});
  ['badge-maint'].forEach(id=>{const el=document.getElementById(id);if(el){el.textContent=faulty;el.style.display=faulty>0?'':'none';}});
  ['badge-fa'].forEach(id=>{const el=document.getElementById(id);if(el){el.textContent=fa;el.style.display=fa>0?'':'none';}});
  ['bnav-dot-daily'].forEach(id=>{const el=document.getElementById(id);if(el)el.style.display=!dailyDone?'block':'none';});
  ['bnav-dot-maint'].forEach(id=>{const el=document.getElementById(id);if(el)el.style.display=faulty>0?'block':'none';});
  const td=document.getElementById('topbar-date');
  if(td)td.textContent=new Date().toLocaleDateString('en-SG',{day:'2-digit',month:'short',year:'numeric'});
  const t=document.getElementById('signin-time');
  if(t&&currentStaff)t.textContent=new Date().toLocaleString('en-SG');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showModal(title,bodyHtml,footerHtml,size){
  const cls=size==='xl'?' modal-xl':size==='wide'?' modal-wide':'';
  document.getElementById('modal-container').innerHTML=`
  <div class="modal-ov" onclick="if(event.target===this)closeModal()">
    <div class="modal${cls}">
      <div class="modal-hd"><div class="modal-title">${esc(title)}</div><button class="modal-close" onclick="closeModal()">âœ•</button></div>
      <div class="modal-body" id="modal-body">${bodyHtml}</div>
      ${footerHtml?`<div class="modal-ft">${footerHtml}</div>`:''}
    </div>
  </div>`;
}
function closeModal(){document.getElementById('modal-container').innerHTML='';}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SEED DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function seedData(){
  if(DB.assets.length>0)return;
  // Assets across facilities
  DB.assets=[
    {id:'A001',tag:'T11-FIN-001',name:'3D Printer Ultimaker S5',serial:'UM-S5-1234',model:'Ultimaker S5',facility:'T11C01',location:'Bay A',cost:12000,nbv:8000,category:'Manufacturing',status:'Active',vendor:'Ultimaker SG',maintenanceDate:'2025-05-15',contractExpiry:'2026-05-15',faultyDate:null,photo:null,pinX:30,pinY:40,usageHours:320,lastUsed:new Date(Date.now()-86400000*2).toISOString(),spendCategory:'Fixed Asset',description:'FDM 3D printer for prototyping and fabrication',dateAcquired:'2022-03-01',assetClass:'Machinery & Equipment',assetType:'Printing Equipment'},
    {id:'A002',tag:'T11-FIN-002',name:'Laser Cutter Epilog Fusion',serial:'EL-FU-5678',model:'Fusion Pro 36',facility:'T11C01',location:'Bay B',cost:28000,nbv:20000,category:'Manufacturing',status:'Faulty',vendor:'Epilog Singapore',maintenanceDate:'2025-04-10',contractExpiry:'2026-01-10',faultyDate:new Date(Date.now()-86400000*1.5).toISOString(),photo:null,pinX:55,pinY:45,usageHours:850,lastUsed:new Date(Date.now()-86400000*3).toISOString()},
    {id:'A003',tag:'T11-FIN-003',name:'CNC Router ShopBot',serial:'SB-CNC-9012',model:'ShopBot Desktop',facility:'T11C01',location:'Bay C',cost:15000,nbv:10500,category:'Manufacturing',status:'Active',vendor:'ShopBot Asia',maintenanceDate:'2025-07-20',contractExpiry:'2026-07-20',faultyDate:null,photo:null,pinX:70,pinY:35,usageHours:510,lastUsed:new Date(Date.now()-86400000*1).toISOString()},
    {id:'A004',tag:'T14-FIN-001',name:'Oscilloscope Tektronix',serial:'TK-OSC-3456',model:'TDS2024C',facility:'T1442',location:'Lab Bench 1',cost:3500,nbv:2800,category:'Electronics',status:'Active',vendor:'Tektronix SG',maintenanceDate:'2025-09-01',contractExpiry:'2026-09-01',faultyDate:null,photo:null,pinX:40,pinY:50,usageHours:180,lastUsed:new Date(Date.now()-86400000*5).toISOString()},
    {id:'A005',tag:'T14-FIN-002',name:'Power Supply Rigol DP832',serial:'DP-832-7890',model:'DP832',facility:'T1442',location:'Lab Bench 2',cost:2200,nbv:1900,category:'Electronics',status:'Active',vendor:'Rigol Technologies',maintenanceDate:'2026-01-01',contractExpiry:'2027-01-01',faultyDate:null,photo:null,pinX:60,pinY:55,usageHours:95,lastUsed:new Date(Date.now()-86400000*1).toISOString()},
    {id:'A006',tag:'MKS-FIN-001',name:'Vinyl Cutter Roland GX-24',serial:'RG-GX24-2345',model:'GX-24',facility:'Makerspace',location:'Craft Area',cost:4500,nbv:3200,category:'Fabrication',status:'Active',vendor:'Roland DGA',maintenanceDate:'2025-06-15',contractExpiry:'2026-06-15',faultyDate:null,photo:null,pinX:45,pinY:45,usageHours:240,lastUsed:new Date(Date.now()-86400000*4).toISOString()},
    {id:'A007',tag:'MKS-FIN-002',name:'Sewing Machine Singer 4411',serial:'SG-4411-6789',model:'Heavy Duty 4411',facility:'Makerspace',location:'Textile Corner',cost:800,nbv:600,category:'Fabrication',status:'Under Maintenance',vendor:'Singer Singapore',maintenanceDate:'2025-03-01',contractExpiry:'2026-03-01',faultyDate:null,photo:null,pinX:65,pinY:60,usageHours:450,lastUsed:new Date(Date.now()-86400000*7).toISOString()},
  ];
  // First aid per facility
  ['T11C01','T1442','Makerspace'].forEach(fid=>{
    DB.firstAid[fid]=[
      {id:`fa-${fid}-1`,name:'Adhesive Bandages (Box 100)',qty:3,minQty:2,expiry:'2026-04-01',location:'Cabinet A'},
      {id:`fa-${fid}-2`,name:'Sterile Gauze Pads 10x10cm',qty:2,minQty:3,expiry:'2025-09-15',location:'Cabinet A'},
      {id:`fa-${fid}-3`,name:'Antiseptic Solution 1L',qty:1,minQty:2,expiry:'2025-05-30',location:'Cabinet A'},
      {id:`fa-${fid}-4`,name:'Burn Gel Sachets',qty:0,minQty:3,expiry:'2025-12-01',location:'Cabinet B'},
      {id:`fa-${fid}-5`,name:'Eye Wash Solution 500ml',qty:2,minQty:2,expiry:'2025-06-30',location:'Cabinet B'},
      {id:`fa-${fid}-6`,name:'Disposable Gloves (Box)',qty:5,minQty:3,expiry:'2026-12-01',location:'Cabinet A'},
      {id:`fa-${fid}-7`,name:'Triangular Bandage',qty:4,minQty:2,expiry:'2027-01-01',location:'Cabinet B'},
    ];
  });
  // Usage log seed
  const now=Date.now();
  DB.assets.forEach(a=>{
    for(let i=30;i>=0;i--){
      if(Math.random()>0.3){
        DB.usageLog.push({assetId:a.id,facility:a.facility,date:new Date(now-i*86400000).toISOString().slice(0,10),hours:+(Math.random()*4+0.5).toFixed(1)});
      }
    }
  });
  dbSave();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WSH CHECKLISTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DAILY_CHECKLIST = [
  {id:'d1',text:'There are no spills, wet patches, debris, obstacles or sharp objects in the walkway and around machinery/equipment that may cause injury.'},
  {id:'d2',text:'All emergency exits and pathways are clear and unobstructed.'},
  {id:'d3',text:'Relevant PPEs are present, usable and stored properly at the workshop.'},
  {id:'d4',text:'First aid box, fire extinguishers, spill kits (and other safety devices) are present in the workshop.'},
  {id:'d5',text:'Machinery/equipment does not have loose plugs or frayed/exposed wiring. Electrical sockets are not overloaded.'},
  {id:'d6',text:'Machinery/equipment does not have abnormal noise, vibration or overheat when initiated. There are no burnt marks or smell.'},
  {id:'d7',text:'Machine guarding and/or interlocks are present on relevant machinery/equipment.'},
  {id:'d8',text:'Tool shadow boards and equipment racks are orderly arranged with no missing tools.'},
  {id:'d9',text:'Hand tools are free from defects e.g. cracked handles.'},
  {id:'d10',text:'Power switches in the OFF position when not in use or awaiting maintenance.'},
  {id:'d11',text:'Workshop has appropriate ventilation. Local exhaust ventilation systems (fume hood, dust collectors, etc) are working properly.'},
  {id:'d12',text:'Chemicals and chemical waste are properly labelled and stored correctly in their designated cabinets. Chemical storage areas are locked.'},
  {id:'d13',text:'Warning labels & signage are clearly visible and in good condition.'},
  {id:'d14',text:'General waste bins and recycling bins are not overflowing.'},
  {id:'d15',text:'CCTVs are in good working condition.'},
];

const MONTHLY_CHECKLIST = [
  {id:'m1',text:'All fire extinguishers have appropriate pressure gauge status, expiry date and physical condition.'},
  {id:'m2',text:'First aid box and spill kit items are checked, fully stocked and free from expired consumables.'},
  {id:'m3',text:'Emergency shower and eye wash are functioning.'},
  {id:'m4',text:'Fume hood and local exhaust ventilation systems have acceptable face velocities.'},
  {id:'m5',text:'PPE consumables supply replenished and not expired.'},
  {id:'m6',text:'Non-consumable PPE inspected to verify usable condition.'},
  {id:'m7',text:'Storage racks, shelves and cabinets are checked for overloading, corrosion, or instability.'},
  {id:'m8',text:'Ceiling boards/tiles are not wet or loose. Nothing will potentially fall from above.'},
  {id:'m9',text:'Machinery / equipment that requires monthly maintenance or calibration are carried out.'},
  {id:'m10',text:'Chemical inventory is updated, and safety datasheets are available / accessible. Incompatible chemicals properly segregated.'},
  {id:'m11',text:'The integrity of machine guarding, interlocks and emergency stop buttons are physically checked.'},
  {id:'m12',text:'Power distribution boards, motor control centre panels and lockout points (where applicable) are checked.'},
  {id:'m13',text:'Grounding and bonding of electrical systems and benches are checked.'},
  {id:'m14',text:'Workshop safety signage, exit signs and emergency lighting (where applicable) are in good working condition.'},
  {id:'m15',text:'Workshop with loud noises have the noise level reviewed to remain within permissible limits.'},
  {id:'m16',text:'Compressed gas cylinders (where applicable) remain securely restrained, regulators/hose connection tight and the valve protection is in order.'},
  {id:'m17',text:'All machinery / equipment is SP property and is approved to be in the workshop.'},
];

// Yearly = Hazard Identification Checklist (Yes/No/NA + Remarks)
const YEARLY_CHECKLIST = [
  {section:'1. Placement of Machinery',items:[
    {id:'y1a',text:'Inadequate, improper or missing operating instructions for machinery'},
    {id:'y1b',text:'Too far from appropriate power supply point which necessitate the use of extension cords.'},
    {id:'y1c',text:'Obstruction to passageway or emergency access route'},
    {id:'y1d',text:'Insufficient space for safe operation and maintenance'},
    {id:'y1e',text:'Inappropriate height for users to operate the machinery safely'},
  ]},
  {section:'2. Mechanical Hazards',items:[
    {id:'y2a',text:'Crushing hazard'},{id:'y2b',text:'Shearing hazard'},{id:'y2c',text:'Cutting or severing hazard'},
    {id:'y2d',text:'Entanglement hazard'},{id:'y2e',text:'Drawing-in or trapping hazard'},{id:'y2f',text:'Impact hazard'},
    {id:'y2g',text:'Stabbing or puncture hazard'},{id:'y2h',text:'Friction or abrasion hazard'},
    {id:'y2i',text:'High pressure fluid injection or ejection hazard'},
  ]},
  {section:'3. Electrical Hazards',items:[
    {id:'y3a',text:'Contact of persons with live parts (direct contact)?'},
    {id:'y3b',text:'Contact of persons with parts which have become live under faulty conditions (indirect contact)?'},
    {id:'y3c',text:'Access to live parts under high voltage?'},
    {id:'y3d',text:'Electrostatic phenomena?'},
    {id:'y3e',text:'Thermal radiation or other phenomena such as the projection of molten particles and chemicals effects from short circuit, overloads, etc?'},
  ]},
  {section:'4. Thermal Hazards',items:[
    {id:'y4a',text:'Burns, scalds and other injuries by possible contact of persons with objects or materials with an extremely high or low temperatures, by flame or explosions and also by the radiation of heat sources?'},
    {id:'y4b',text:'Damage to health by hot or cold working environment?'},
  ]},
  {section:'5. Noise',items:[
    {id:'y5a',text:'Hearing loss (deafness) or other physiological disorders (eg: loss of balance, loss of awareness)?'},
    {id:'y5b',text:'Interference with speech communication, acoustic signals, etc?'},
  ]},
  {section:'6. Vibration',items:[
    {id:'y6a',text:'The use of hand-held machines resulting in a variety of neurological and vascular disorders?'},
    {id:'y6b',text:'Whole-body vibration, particularly when combined with poor posture?'},
  ]},
  {section:'7. Radiation',items:[
    {id:'y7a',text:'Low frequency, radio-frequency radiation or microwaves?'},
    {id:'y7b',text:'Infrared, visible and ultraviolet radiation?'},
    {id:'y7c',text:'X-ray or gamma rays?'},
    {id:'y7d',text:'Alpha / beta rays, electron or ion beams or neutrons?'},
    {id:'y7e',text:'Lasers?'},
  ]},
  {section:'8. Chemical, Fire, Biological Hazards',items:[
    {id:'y8a',text:'Contact with or inhalation of harmful chemicals, fluids, gases, mists, fumes and dusts?'},
    {id:'y8b',text:'Fire or explosions?'},
    {id:'y8c',text:'Biological or microbiological (virus / bacteria) hazards?'},
  ]},
  {section:'9. Ergonomic Hazards',items:[
    {id:'y9a',text:'Unhealthy postures or excessive effort?'},
    {id:'y9b',text:'Inadequate consideration of hand-arm or foot-leg anatomy?'},
    {id:'y9c',text:'Neglected use of personal protective equipment?'},
    {id:'y9d',text:'Inadequate local lighting?'},
    {id:'y9e',text:'Mental overload and underload of stress?'},
    {id:'y9f',text:'Human error or behaviour?'},
    {id:'y9g',text:'Inadequate design, location or identification of manual controls?'},
    {id:'y9h',text:'Inadequate design or location of visual display units?'},
  ]},
  {section:'10. Machinery Malfunctions',items:[
    {id:'y10a',text:'Failure / disorder of control systems'},
    {id:'y10b',text:'Restoration of energy supply after an interruption?'},
    {id:'y10c',text:'External influences on electrical equipment'},
    {id:'y10d',text:'Other external influences (eg: gravity, wind, etc)?'},
    {id:'y10e',text:'Errors in software'},
    {id:'y10f',text:'Errors made by operators'},
  ]},
  {section:'11. Movement of Mechanical Parts',items:[
    {id:'y11a',text:'Movement when starting the engine?'},
    {id:'y11b',text:'Movement without a driver at the driving position?'},
    {id:'y11c',text:'Movement without all parts in a safe position?'},
    {id:'y11d',text:'Excessive speed of pedestrian-controlled machinery?'},
    {id:'y11e',text:'Excessive oscillations when in motion?'},
    {id:'y11f',text:'Insufficient ability of machinery to be slowed down, stopped and immobilised?'},
  ]},
  {section:'12. Unsafe Work Positions',items:[
    {id:'y12a',text:'Fall of persons during access to or egress from the work position?'},
    {id:'y12b',text:'Inhalation of exhaust gases or lack of oxygen at the workplace?'},
    {id:'y12c',text:'Fire?'},
    {id:'y12d',text:'Mechanical hazards at the work position, including contact with wheels; rollover; fall of objects, penetration by objects; break-up of parts rotating at high speed; contact of persons with machine parts or tools'},
    {id:'y12e',text:'Insufficient visibility from the work positions'},
    {id:'y12f',text:'Inadequate lighting?'},{id:'y12g',text:'Inadequate sitting?'},
    {id:'y12h',text:'Noise at the work position?'},{id:'y12i',text:'Excessive vibration at the work position?'},
    {id:'y12j',text:'Insufficient means for evacuation / emergency exit?'},
  ]},
  {section:'13. Control Systems',items:[
    {id:'y13a',text:'Inadequate location of manual controls?'},
    {id:'y13b',text:'Inadequate design of manual controls and their mode of operation?'},
  ]},
  {section:'14. Lifting Work',items:[
    {id:'y14a',text:'Lack of machine stability?'},{id:'y14b',text:'Possible overloading?'},
    {id:'y14c',text:'Uncontrolled amplitude of movements?'},{id:'y14d',text:'Unexpected / unintended movement of loads?'},
    {id:'y14e',text:'Inadequate holding devices / accessories?'},{id:'y14f',text:'Collision of more than one machine?'},
    {id:'y14g',text:'Insufficient mechanical strength of parts?'},
    {id:'y14h',text:'Inadequate selection of chains, ropes and other lifting accessories, and their inadequate integration into the machine?'},
    {id:'y14i',text:'Inadequate design of pulleys, drums?'},
  ]},
  {section:'15. Others',items:[
    {id:'y15a',text:'Is it impossible to stop the machine under abnormal or emergency situations?'},
    {id:'y15b',text:'Are there variations in the rotational speed of tools that is of concern?'},
    {id:'y15c',text:'Are there hazards generated because of power failure?'},
    {id:'y15d',text:'Are there hazards generated because of failure in the critical control circuit?'},
    {id:'y15e',text:'Are there hazards generated due to errors in fitting?'},
    {id:'y15f',text:'Are there hazards generated due to a break-up of material during operation?'},
    {id:'y15g',text:'Are there hazards generated due to a loss of stability or overturning of machinery?'},
    {id:'y15h',text:'Are there hazards generated because of transmission of power between machines?'},
    {id:'y15i',text:'Are there new hazards generated because of combination of hazards?'},
  ]},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WSH CHECKLIST RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getCheckKey(period, dateKey){return`${currentFacility}-${period}-${dateKey}`;}
function getCheckState(period, dateKey){return DB.wshChecks[getCheckKey(period,dateKey)]||{answers:{},remarks:{},submitted:false,submittedBy:'',submittedAt:''};}

function renderWSH(root, period){
  const isDaily=(period==='daily'), isMonthly=(period==='monthly'), isYearly=(period==='yearly');
  let dateKey, label, checklist, canSubmit=true, lockMsg='';

  if(isDaily){
    dateKey=todayStr();
    label=`Daily â€” ${fmtDate(dateKey)} â€” ${currentFacility}`;
    checklist=DAILY_CHECKLIST;
  } else if(isMonthly){
    dateKey=monthKey();
    label=`Monthly â€” ${dateKey} â€” ${currentFacility}`;
    checklist=MONTHLY_CHECKLIST;
    // Check if we can submit new (1 month lockout)
    const lastKey=Object.keys(DB.wshChecks).filter(k=>k.startsWith(`${currentFacility}-monthly-`)&&k!==getCheckKey(period,dateKey)&&DB.wshChecks[k].submitted).sort().pop();
    if(lastKey){
      const lastDate=lastKey.split('-').slice(-2).join('-');
      const lastMs=new Date(lastDate+'-01').getTime();
      const nowMs=new Date(dateKey+'-01').getTime();
      const diff=(nowMs-lastMs)/(1000*60*60*24*30);
      if(diff<1){canSubmit=false;lockMsg=`Monthly checklist can only be submitted once per month. Last submission: ${lastDate}.`;}
    }
  } else {
    dateKey=yearKey();
    label=`Hazard Identification â€” ${dateKey} â€” ${currentFacility}`;
    checklist=null; // Yearly uses sections
    const lastKey=Object.keys(DB.wshChecks).filter(k=>k.startsWith(`${currentFacility}-yearly-`)&&k!==getCheckKey(period,dateKey)&&DB.wshChecks[k].submitted).sort().pop();
    if(lastKey){
      const ly=parseInt(lastKey.split('-').slice(-1)[0]);
      const cy=new Date().getFullYear();
      if(cy<=ly){canSubmit=false;lockMsg=`Hazard checklist already submitted for ${ly}.`;}
    }
  }

  const state=getCheckState(period,dateKey);
  const items=isYearly ? YEARLY_CHECKLIST.flatMap(s=>s.items) : checklist;
  const answered=items.filter(i=>state.answers[i.id]).length;
  const pct=Math.round(answered/items.length*100);
  const allYes=items.every(i=>state.answers[i.id]==='yes');

  root.innerHTML=`
  <div class="cl-form-banner">
    <div>
      <div class="cl-form-title">${isYearly?'Hazard Identification Checklist for Machinery & Equipment':(isMonthly?'Monthly Workshop Safety Checklist':'Daily Workshop Safety Checklist')}</div>
      <div class="cl-form-meta">Venue: ${currentFacility} &nbsp;Â·&nbsp; ${label} ${state.submitted?`<span style="color:var(--green);margin-left:8px">âœ“ Submitted by ${esc(state.submittedBy)}</span>`:''}</div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      ${isMonthly&&!canSubmit?`<span class="pill pill-yellow">ğŸ”’ Locked</span>`:''}
      <button class="btn btn-success btn-sm" onclick="checkAllYes('${period}','${dateKey}')">âœ… All Yes</button>
      <button class="btn btn-danger btn-sm" onclick="checkAllNo('${period}','${dateKey}')">âœ– All No</button>
      <button class="btn btn-sec btn-sm" onclick="checkAllNA('${period}','${dateKey}')">â€” All N/A</button>
      <button class="btn btn-warn btn-sm" onclick="checkClear('${period}','${dateKey}')">ğŸ—‘ Clear</button>
      ${state.submitted?`<button class="btn btn-teal btn-sm" onclick="duplicateWSH('${period}')">ğŸ“‹ Duplicate to Next</button>`:''}
      <button class="btn btn-sec btn-sm" onclick="exportWSH('${period}','${dateKey}')">â¬‡ Export</button>
    </div>
  </div>
  ${lockMsg?`<div class="alert al-warn">ğŸ”’ ${esc(lockMsg)}</div>`:''}
  ${state.submitted?`<div class="alert al-success">âœ“ Submitted ${fmtDateTime(state.submittedAt)} by ${esc(state.submittedBy)}</div>`:''}
  <div class="prog-wrap">
    <div class="prog-meta"><span>${answered}/${items.length} answered</span><span>${pct}%</span></div>
    <div class="prog-bar"><div class="prog-fill" style="width:${pct}%;background:${pct===100?'var(--green)':pct>60?'var(--blue)':'var(--yellow)'}"></div></div>
  </div>
  <div id="wsh-items">
  ${isYearly
    ? YEARLY_CHECKLIST.map(sec=>`
      <div class="cl-section">${esc(sec.section)}</div>
      ${sec.items.map(item=>renderWSHItem(item,state,true)).join('')}
      `).join('')
    : checklist.map(item=>renderWSHItem(item,state,false)).join('')
  }
  </div>
  <div style="margin-top:18px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;padding-top:14px;border-top:1px solid var(--border)">
    ${canSubmit&&!state.submitted?`<button class="btn btn-pri" onclick="submitWSH('${period}','${dateKey}')" ${answered===0?'disabled':''}>âœ“ Submit & Sign Off</button>`:''}
    ${state.submitted?`<button class="btn btn-warn btn-sm" onclick="reopenWSH('${period}','${dateKey}')">âœï¸ Reopen & Edit</button>`:''}
    <span style="color:var(--t3);font-size:.72rem">All changes auto-saved</span>
  </div>
  <div style="margin-top:24px;border-top:1px solid var(--border);padding-top:18px">
    <div class="card-hd">Submission History</div>
    ${renderWSHHistory(period)}
  </div>`;
}

function renderWSHItem(item, state, hasRemarks){
  const ans=state.answers[item.id]||'';
  const rem=state.remarks?.[item.id]||'';
  const cls=ans==='yes'?'ans-yes':ans==='no'?'ans-no':ans==='na'?'ans-na':'';
  return`<div class="cl-item ${cls}" id="cli-${item.id}">
    <div class="cl-num">${item.id.replace(/[a-z]/,'').replace(/\d+/,'').length?item.id:item.id}</div>
    <div style="flex:1">
      <div class="cl-text">${esc(item.text)}</div>
      ${hasRemarks?`<textarea class="cl-remarks" placeholder="Remarks (optional)..." onchange="setWSHRemark(event,'${item.id}')" rows="1">${esc(rem)}</textarea>`:''}
    </div>
    <div class="cl-btns">
      <button class="cl-btn ${ans==='yes'?'sel-yes':''}" onclick="setWSHAns(event,'${item.id}','yes')">YES</button>
      <button class="cl-btn ${ans==='no'?'sel-no':''}" onclick="setWSHAns(event,'${item.id}','no')">NO</button>
      <button class="cl-btn ${ans==='na'?'sel-na':''}" onclick="setWSHAns(event,'${item.id}','na')">N/A</button>
    </div>
  </div>`;
}

function setWSHAns(e,itemId,val){
  e.stopPropagation();
  const period=currentPage.replace('wsh-','');
  const dateKey=period==='daily'?todayStr():period==='monthly'?monthKey():yearKey();
  const key=getCheckKey(period,dateKey);
  if(!DB.wshChecks[key])DB.wshChecks[key]={answers:{},remarks:{},submitted:false,submittedBy:'',submittedAt:''};
  DB.wshChecks[key].answers[itemId]=val;
  dbSave();
  // update UI
  const item=document.getElementById('cli-'+itemId);
  if(item){
    item.className='cl-item '+(val==='yes'?'ans-yes':val==='no'?'ans-no':'ans-na');
    item.querySelectorAll('.cl-btn').forEach(b=>{b.className='cl-btn';});
    const btns=item.querySelectorAll('.cl-btn');
    if(btns[0])btns[0].className='cl-btn '+(val==='yes'?'sel-yes':'');
    if(btns[1])btns[1].className='cl-btn '+(val==='no'?'sel-no':'');
    if(btns[2])btns[2].className='cl-btn '+(val==='na'?'sel-na':'');
  }
  // update progress
  const p=period==='daily'?DAILY_CHECKLIST:period==='monthly'?MONTHLY_CHECKLIST:YEARLY_CHECKLIST.flatMap(s=>s.items);
  const answered=p.filter(i=>DB.wshChecks[key].answers[i.id]).length;
  const pct=Math.round(answered/p.length*100);
  const pf=document.querySelector('.prog-fill');
  if(pf){pf.style.width=pct+'%';pf.style.background=pct===100?'var(--green)':pct>60?'var(--blue)':'var(--yellow)';}
  document.querySelectorAll('.prog-meta span')[0].textContent=`${answered}/${p.length} answered`;
  document.querySelectorAll('.prog-meta span')[1].textContent=pct+'%';
}

function setWSHRemark(e,itemId){
  const period=currentPage.replace('wsh-','');
  const dateKey=period==='daily'?todayStr():period==='monthly'?monthKey():yearKey();
  const key=getCheckKey(period,dateKey);
  if(!DB.wshChecks[key])DB.wshChecks[key]={answers:{},remarks:{},submitted:false,submittedBy:'',submittedAt:''};
  if(!DB.wshChecks[key].remarks)DB.wshChecks[key].remarks={};
  DB.wshChecks[key].remarks[itemId]=e.target.value;
  dbSave();
}

function checkAllYes(period,dateKey){ bulkSetWSH(period,dateKey,'yes'); }
function checkAllNo(period,dateKey){  bulkSetWSH(period,dateKey,'no');  }
function checkAllNA(period,dateKey){  bulkSetWSH(period,dateKey,'na');  }
function checkClear(period,dateKey){  bulkSetWSH(period,dateKey,'');   }

function bulkSetWSH(period,dateKey,val){
  const key=getCheckKey(period,dateKey);
  if(!DB.wshChecks[key])DB.wshChecks[key]={answers:{},remarks:{},submitted:false,submittedBy:'',submittedAt:''};
  const items=period==='daily'?DAILY_CHECKLIST:period==='monthly'?MONTHLY_CHECKLIST:YEARLY_CHECKLIST.flatMap(s=>s.items);
  if(val===''){
    DB.wshChecks[key].answers={};
  } else {
    items.forEach(i=>{DB.wshChecks[key].answers[i.id]=val;});
  }
  dbSave();
  navigate('wsh-'+period);
}

function submitWSH(period,dateKey){
  if(!requireStaff())return;
  const key=getCheckKey(period,dateKey);
  const items=period==='daily'?DAILY_CHECKLIST:period==='monthly'?MONTHLY_CHECKLIST:YEARLY_CHECKLIST.flatMap(s=>s.items);
  const answered=items.filter(i=>DB.wshChecks[key]?.answers[i.id]).length;
  if(answered<items.length*0.5){if(!confirm(`Only ${answered}/${items.length} items answered. Submit anyway?`))return;}
  if(!DB.wshChecks[key])DB.wshChecks[key]={answers:{},remarks:{}};
  DB.wshChecks[key].submitted=true;
  DB.wshChecks[key].submittedBy=currentStaff.name;
  DB.wshChecks[key].submittedAt=new Date().toISOString();
  // Add to history
  DB.wshHistory.push({id:'wh'+Date.now(),facility:currentFacility,period,dateKey,submittedBy:currentStaff.name,submittedAt:new Date().toISOString(),answers:{...DB.wshChecks[key].answers},remarks:{...DB.wshChecks[key].remarks||{}}});
  auditLog(`Submitted ${period} WSH checklist`,`${currentFacility} â€” ${dateKey}`);
  dbSave();updateBadges();navigate('wsh-'+period);
}

function reopenWSH(period,dateKey){
  if(!requireStaff())return;
  const key=getCheckKey(period,dateKey);
  if(DB.wshChecks[key]){DB.wshChecks[key].submitted=false;DB.wshChecks[key].submittedBy='';}
  auditLog(`Reopened ${period} WSH checklist`,`${currentFacility} â€” ${dateKey}`);
  dbSave();navigate('wsh-'+period);
}

function duplicateWSH(period){
  if(!requireStaff())return;
  const srcDateKey=period==='daily'?todayStr():period==='monthly'?monthKey():yearKey();
  const src=DB.wshChecks[getCheckKey(period,srcDateKey)];
  if(!src)return;
  let destDateKey;
  if(period==='daily'){const d=new Date();d.setDate(d.getDate()+1);destDateKey=d.toISOString().slice(0,10);}
  else if(period==='monthly'){const d=new Date();d.setMonth(d.getMonth()+1);destDateKey=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;}
  else{destDateKey=String(new Date().getFullYear()+1);}
  const destKey=getCheckKey(period,destDateKey);
  DB.wshChecks[destKey]={answers:{...src.answers},remarks:{...(src.remarks||{})},submitted:false,submittedBy:'',submittedAt:''};
  auditLog(`Duplicated ${period} WSH checklist to ${destDateKey}`,currentFacility);
  dbSave();alert(`âœ“ Checklist pre-filled for ${destDateKey}. Switch to that date to review and submit.`);
}

function renderWSHHistory(period){
  const hist=DB.wshHistory.filter(h=>h.facility===currentFacility&&h.period===period).slice(0,10);
  if(!hist.length)return`<div class="empty" style="padding:20px"><div class="empty-icon">ğŸ“‹</div><div style="font-size:.78rem">No submissions yet</div></div>`;
  return`<div class="tbl-wrap"><table><thead><tr><th>Date</th><th>Submitted By</th><th>Submitted At</th><th>Score</th><th>Actions</th></tr></thead><tbody>
  ${hist.map(h=>{
    const items=period==='daily'?DAILY_CHECKLIST:period==='monthly'?MONTHLY_CHECKLIST:YEARLY_CHECKLIST.flatMap(s=>s.items);
    const yes=items.filter(i=>h.answers[i.id]==='yes').length;
    const pct=Math.round(yes/items.length*100);
    return`<tr>
      <td style="font-family:'JetBrains Mono',monospace;font-size:.7rem">${esc(h.dateKey)}</td>
      <td>${esc(h.submittedBy)}</td>
      <td style="font-size:.7rem;color:var(--t3)">${fmtDateTime(h.submittedAt)}</td>
      <td><span class="pill pill-${pct===100?'green':pct>60?'yellow':'red'}">${pct}% YES</span></td>
      <td><button class="btn btn-xs btn-sec" onclick="exportWSHHistEntry('${h.id}')">â¬‡ Export</button></td>
    </tr>`;
  }).join('')}
  </tbody></table></div>`;
}

function exportWSH(period,dateKey){
  const key=getCheckKey(period,dateKey);
  const state=DB.wshChecks[key]||{answers:{},remarks:{}};
  const isYearly=(period==='yearly');
  const items=isYearly?YEARLY_CHECKLIST.flatMap(s=>s.items):period==='monthly'?MONTHLY_CHECKLIST:DAILY_CHECKLIST;
  const title=isYearly?'Hazard Identification Checklist':period==='monthly'?'Monthly Workshop Safety Checklist':'Daily Workshop Safety Checklist';
  const lines=[title,'='.repeat(50),`Facility   : ${currentFacility}`,`Period     : ${dateKey}`,`Status     : ${state.submitted?'SUBMITTED':'DRAFT'}`,`Submitted  : ${state.submitted?`${state.submittedBy} @ ${fmtDateTime(state.submittedAt)}`:'â€”'}`,`Exported   : ${fmtDateTime(new Date().toISOString())}`,``];
  if(isYearly){
    YEARLY_CHECKLIST.forEach(sec=>{
      lines.push(`\n${sec.section}`,'-'.repeat(40));
      sec.items.forEach(i=>{
        const a=state.answers[i.id]||'?';const r=state.remarks?.[i.id]||'';
        lines.push(`[${a.toUpperCase()}] ${i.text}${r?'\n     Remarks: '+r:''}`);
      });
    });
  } else {
    items.forEach((i,idx)=>{
      const a=state.answers[i.id]||'?';
      lines.push(`${idx+1}. [${a.toUpperCase()}] ${i.text}`);
    });
  }
  const blob=new Blob([lines.join('\n')],{type:'text/plain'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=`${currentFacility}_${period}_${dateKey}.txt`;a.click();URL.revokeObjectURL(url);
  auditLog('Exported WSH checklist',`${period} ${dateKey}`);
}

function exportWSHHistEntry(id){
  const h=DB.wshHistory.find(x=>x.id===id);if(!h)return;
  const period=h.period;
  const key=`${h.facility}-${period}-${h.dateKey}`;
  // temporarily set to export that entry
  const savedFac=currentFacility;
  currentFacility=h.facility;
  const tmpKey=key;
  const state={answers:h.answers,remarks:h.remarks||{},submitted:true,submittedBy:h.submittedBy,submittedAt:h.submittedAt};
  const old=DB.wshChecks[tmpKey];
  DB.wshChecks[tmpKey]=state;
  exportWSH(period,h.dateKey);
  if(old)DB.wshChecks[tmpKey]=old;
  currentFacility=savedFac;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard(root){
  const fAssets=facAssets();
  const faulty=fAssets.filter(a=>a.status==='Faulty');
  const mDue=fAssets.filter(a=>a.maintenanceDate&&daysUntil(a.maintenanceDate)<=30);
  const faItems=facFirstAid();
  const faAlerts=faItems.filter(i=>faStatus(i)!=='OK');
  const dailyKey=todayStr();
  const dailyState=getCheckState('daily',dailyKey);
  const dailyPct=dailyState.submitted?100:Math.round(DAILY_CHECKLIST.filter(i=>dailyState.answers[i.id]).length/DAILY_CHECKLIST.length*100);
  const g=new Date().getHours();
  const greetWord=g<12?'Good Morning':g<18?'Good Afternoon':'Good Evening';
  const greetEmoji=g<12?'ğŸŒ¤ï¸':g<18?'ğŸ‘‹':'ğŸŒ™';
  const staffName=currentStaff?`, ${currentStaff.name.split(' ')[0]}`:'';

  root.innerHTML=`
  <div style="margin-bottom:20px">
    <div style="font-size:1.45rem;font-weight:800;letter-spacing:-.03em">${greetWord}${staffName} ${greetEmoji}</div>
    <div style="color:var(--t3);font-size:.82rem;margin-top:4px">${new Date().toLocaleDateString('en-SG',{weekday:'long',year:'numeric',month:'long',day:'numeric'})} Â· Viewing: <strong style="color:var(--fac2)">${currentFacility}</strong></div>
    <div style="font-size:.75rem;color:var(--t3);margin-top:3px;opacity:.6">Tap a card below to jump to that section</div>
  </div>
  <div class="stats-row stats-4" style="margin-bottom:14px">
    <div class="stat-card sc-blue clickable" onclick="navigate('assets')" title="View all assets">
      <div class="stat-lbl">Total Assets</div>
      <div class="stat-val sv-blue">${fAssets.length}</div>
      <div class="stat-sub">${currentFacility}</div>
      <span class="stat-card-arrow">â†’</span>
    </div>
    <div class="stat-card sc-red clickable" onclick="navigate('assets');setTimeout(()=>{document.querySelectorAll('.filter-btn').forEach(b=>{if(b.textContent==='Faulty')b.click();});},200)" title="View faulty equipment">
      <div class="stat-lbl">Faulty Now</div>
      <div class="stat-val sv-red">${faulty.length}</div>
      <div class="stat-sub">Equipment down</div>
      <span class="stat-card-arrow">â†’</span>
    </div>
    <div class="stat-card sc-yellow clickable" onclick="navigate('maintenance')" title="View maintenance schedule">
      <div class="stat-lbl">Maint. Due</div>
      <div class="stat-val sv-yellow">${mDue.length}</div>
      <div class="stat-sub">Next 30 days</div>
      <span class="stat-card-arrow">â†’</span>
    </div>
    <div class="stat-card sc-${faAlerts.length?'orange':'green'} clickable" onclick="navigate('firstaid')" title="View first aid inventory">
      <div class="stat-lbl">First Aid</div>
      <div class="stat-val sv-${faAlerts.length?'orange':'green'}">${faAlerts.length}</div>
      <div class="stat-sub">${faAlerts.length?'Need attention':'All OK'}</div>
      <span class="stat-card-arrow">â†’</span>
    </div>
  </div>
  ${faulty.map(a=>`<div class="alert al-danger">ğŸ”´ <strong>${esc(a.name)}</strong> (${esc(a.tag)}) FAULTY â€” Down ${downtimeStr(a.faultyDate)}</div>`).join('')}
  <div class="g2" style="margin-bottom:14px">
    <div class="card">
      <div class="card-hd">Today's Daily Checklist
        <span class="pill pill-${dailyState.submitted?'green':dailyPct>0?'yellow':'red'}">${dailyState.submitted?'Submitted':dailyPct+'%'}</span>
      </div>
      ${dailyState.submitted
        ?`<div style="color:var(--green);font-size:.8rem">âœ“ Completed by ${esc(dailyState.submittedBy)}</div>`
        :`<div style="font-size:.78rem;color:var(--t3);margin-bottom:8px">${DAILY_CHECKLIST.filter(i=>dailyState.answers[i.id]).length}/${DAILY_CHECKLIST.length} items answered</div>
        <button class="btn btn-pri btn-sm" onclick="navigate('wsh-daily')">Open Checklist â†’</button>`}
    </div>
    <div class="card">
      <div class="card-hd">All Facilities Status</div>
      ${DB.facilities.filter(f=>f.active).map(f=>{
        const fa2=DB.assets.filter(a=>a.facility===f.id&&a.status==='Faulty').length;
        return`<div class="card-row"><span class="fac-tag fac-${f.id}">${f.id}</span><span style="font-size:.75rem;color:var(--t2)">${DB.assets.filter(a=>a.facility===f.id).length} assets</span>${fa2>0?`<span class="pill pill-red">${fa2} faulty</span>`:`<span class="pill pill-green">OK</span>`}</div>`;
      }).join('')}
    </div>
  </div>
  <div class="g2">
    <div class="card">
      <div class="card-hd">ğŸ”§ Maintenance Due â€” 30d</div>
      ${mDue.length===0?`<div class="empty" style="padding:20px"><div class="empty-icon">âœ…</div><div style="font-size:.77rem">All clear</div></div>`
      :mDue.slice(0,5).map(a=>`<div class="card-row"><div><div style="color:var(--t1);font-weight:600;font-size:.79rem">${esc(a.name)}</div><div style="color:var(--t3);font-size:.66rem">${esc(a.location)}</div></div><span class="pill pill-${daysUntil(a.maintenanceDate)<=7?'red':'yellow'}">${daysUntil(a.maintenanceDate)}d</span></div>`).join('')}
    </div>
    <div class="card">
      <div class="card-hd">ğŸ©¹ First Aid Alerts</div>
      ${faAlerts.length===0?`<div class="empty" style="padding:20px"><div class="empty-icon">âœ…</div><div style="font-size:.77rem">All stocked</div></div>`
      :faAlerts.slice(0,6).map(i=>{const s=faStatus(i);return`<div class="card-row"><div style="font-size:.77rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;margin-right:8px">${esc(i.name)}</div><span class="pill pill-${faColor(s)}">${s}</span></div>`}).join('')}
    </div>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ASSETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentSpendFilter='all';
function setAssetFilter(f){currentSpendFilter=f;renderAssets(document.getElementById('page-root'));}
function toggleSubNav(id){
  const el=document.getElementById(id);
  const arrow=document.getElementById(id.replace('-sub','-sub-arrow'));
  if(!el)return;
  el.classList.toggle('open');
  if(arrow)arrow.style.transform=el.classList.contains('open')?'rotate(90deg)':'';
}

function renderAssets(root){
  const allFacAssets=facAssets();
  const fAssets=currentSpendFilter==='all'?allFacAssets:allFacAssets.filter(a=>(a.spendCategory||'Fixed Asset')===currentSpendFilter);
  const faulty=allFacAssets.filter(a=>a.status==='Faulty');
  const upcoming=allFacAssets.filter(a=>a.maintenanceDate&&daysUntil(a.maintenanceDate)<=60&&daysUntil(a.maintenanceDate)>=0);
  const totalNBV=allFacAssets.reduce((s,a)=>s+Number(a.nbv||0),0);
  root.innerHTML=`
  ${faulty.length>0?`<div class="alert al-danger">âš ï¸ ${faulty.length} asset(s) FAULTY in ${currentFacility}</div>`:''}
  <div class="stats-row stats-4">
    <div class="stat-card sc-blue"><div class="stat-lbl">Total Assets</div><div class="stat-val sv-blue">${allFacAssets.length}</div><div class="stat-sub">${currentFacility}</div></div>
    <div class="stat-card sc-teal"><div class="stat-lbl">Fixed Assets</div><div class="stat-val sv-teal">${allFacAssets.filter(a=>(a.spendCategory||'Fixed Asset')==='Fixed Asset').length}</div><div class="stat-sub">Capital items</div></div>
    <div class="stat-card sc-purple"><div class="stat-lbl">LVA</div><div class="stat-val sv-purple">${allFacAssets.filter(a=>a.spendCategory==='LVA').length}</div><div class="stat-sub">Low value assets</div></div>
    <div class="stat-card sc-yellow"><div class="stat-lbl">Total NBV</div><div class="stat-val sv-yellow" style="font-size:1.1rem">${fmtMoney(totalNBV)}</div><div class="stat-sub">Book value</div></div>
  </div>
  <div class="sec-hd" style="flex-wrap:wrap;gap:8px">
    <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center">
      <button class="btn btn-sm ${currentSpendFilter==='all'?'btn-pri':'btn-sec'}" onclick="setAssetFilter('all')">All Assets</button>
      <button class="btn btn-sm ${currentSpendFilter==='Fixed Asset'?'btn-pri':'btn-sec'}" onclick="setAssetFilter('Fixed Asset')">Fixed Assets</button>
      <button class="btn btn-sm ${currentSpendFilter==='LVA'?'btn-pri':'btn-sec'}" onclick="setAssetFilter('LVA')">LVA</button>
    </div>
    <div style="display:flex;gap:7px;flex-wrap:wrap;align-items:center">
      <input class="search" placeholder="Search assets..." value="${esc(assetSearch)}" oninput="assetSearch=this.value;renderAssets(document.getElementById('page-root'))">
      <select class="fsel" style="width:auto;padding:7px 10px;font-size:.77rem" onchange="assetFilter=this.value;renderAssets(document.getElementById('page-root'))">
        ${['All','Active','Faulty','Under Maintenance','Disposed','Withdrawn'].map(s=>`<option ${assetFilter===s?'selected':''}>${s}</option>`).join('')}
      </select>
    </div>
    <div style="display:flex;gap:7px;flex-wrap:wrap">
      <button class="btn btn-teal btn-sm" onclick="openMoveAsset()">â†”ï¸ Move Asset</button>
      <button class="btn btn-sec btn-sm" onclick="downloadCSVTemplate()">ğŸ“¥ CSV Template</button>
      <label class="btn btn-sec btn-sm" style="cursor:pointer">ğŸ“¤ Import CSV<input type="file" accept=".csv" style="display:none" onchange="importCSV(this)"></label>
      <button class="btn btn-pri btn-sm" onclick="openAssetModal(null)">+ Add Asset</button>
    </div>
  </div>
  <div class="tbl-wrap"><table>
    <thead><tr>
      <th>Asset</th><th>Asset Name</th><th>Asset Status</th><th>Spend Cat.</th>
      <th>Description</th><th>Date Acquired</th><th>Asset Cost</th><th>Net Book Value</th>
      <th>Location</th><th>Asset Class</th><th>Asset Type</th><th>Actions</th>
    </tr></thead>
    <tbody>
    ${fAssets.filter(a=>{
      const q=assetSearch.toLowerCase();
      return (!q||a.name.toLowerCase().includes(q)||a.tag.toLowerCase().includes(q)||(a.location||'').toLowerCase().includes(q));
    }).map(a=>{
      return`<tr>
        <td><div style="display:flex;align-items:center;gap:7px">${a.photo?`<img src="${a.photo}" style="width:32px;height:32px;border-radius:5px;object-fit:cover;flex-shrink:0;border:1px solid var(--border)">`:`<div style="width:32px;height:32px;border-radius:5px;background:var(--surface3);display:flex;align-items:center;justify-content:center;font-size:.8rem;flex-shrink:0;border:1px solid var(--border)">ğŸ“·</div>`}<span style="font-family:'JetBrains Mono',monospace;font-size:.72rem;color:var(--fac2);font-weight:700;white-space:nowrap">${esc(a.tag)}</span></div></td>
        <td><div style="font-weight:600;color:var(--t1);font-size:.84rem;min-width:130px">${esc(a.name)}</div><div style="font-size:.7rem;color:var(--t3)">${esc(a.model||'')}</div></td>
        <td>${a.status==='Faulty'&&a.faultyDate?`<span class="pill pill-red">Faulty</span><div style="font-family:'JetBrains Mono',monospace;font-size:.62rem;color:var(--red);margin-top:1px">${downtimeStr(a.faultyDate)}</div>`:`<span class="pill pill-${statusColor(a.status)}">${esc(a.status)}</span>`}</td>
        <td><span class="pill pill-${(a.spendCategory||'Fixed Asset')==='LVA'?'purple':'teal'}">${esc(a.spendCategory||'Fixed Asset')}</span></td>
        <td style="max-width:160px;font-size:.78rem;color:var(--t2);white-space:normal;line-height:1.35">${esc((a.description||'â€”').substring(0,70))}${(a.description||'').length>70?'â€¦':''}</td>
        <td style="font-family:'JetBrains Mono',monospace;font-size:.74rem;white-space:nowrap">${fmtDate(a.dateAcquired)}</td>
        <td style="font-family:'JetBrains Mono',monospace;font-size:.74rem;color:var(--yellow);white-space:nowrap">${fmtMoney(a.cost)}</td>
        <td style="font-family:'JetBrains Mono',monospace;font-size:.74rem;color:var(--green);white-space:nowrap">${fmtMoney(a.nbv)}</td>
        <td style="font-size:.82rem">${esc(a.location||'â€”')}</td>
        <td style="font-size:.78rem;color:var(--t2);white-space:nowrap">${esc(a.assetClass||'â€”')}</td>
        <td style="font-size:.78rem;color:var(--t2);white-space:nowrap">${esc(a.assetType||'â€”')}</td>
        <td><div style="display:flex;gap:2px;flex-wrap:nowrap">
          <button class="btn btn-xs btn-sec" onclick="viewAsset('${a.id}')">ğŸ‘ï¸</button>
          <button class="btn btn-xs btn-sec" onclick="openAssetModal('${a.id}')">âœï¸</button>
          ${a.status==='Faulty'
            ?`<button class="btn btn-xs btn-success" onclick="clearFault('${a.id}')">âœ“Fix</button>`
            :`<button class="btn btn-xs btn-danger" onclick="markFaulty('${a.id}')">âš ï¸</button>`}
          <button class="btn btn-xs btn-warn" onclick="openDisposal('${a.id}')">â†—</button>
        </div></td>
      </tr>`;
    }).join('')}
    </tbody>
  </table></div>
  <div style="margin-top:16px">
    <button class="btn btn-sec btn-sm" onclick="exportAssetChecklist()">ğŸ“„ Export Asset Checklist</button>
  </div>`;
}

function markFaulty(id){
  if(!requireStaff())return;
  DB.assets=DB.assets.map(a=>a.id===id?{...a,status:'Faulty',faultyDate:new Date().toISOString()}:a);
  auditLog('Marked faulty',id);dbSave();updateBadges();renderAssets(document.getElementById('page-root'));
}
function clearFault(id){
  if(!requireStaff())return;
  DB.assets=DB.assets.map(a=>a.id===id?{...a,status:'Active',faultyDate:null}:a);
  auditLog('Cleared fault',id);dbSave();updateBadges();renderAssets(document.getElementById('page-root'));
}
function viewAsset(id){
  const a=DB.assets.find(x=>x.id===id);if(!a)return;
  // PPM prediction
  const ppm=getPPMPrediction(a);
  showModal(a.name,`
  ${a.status==='Faulty'?`<div class="alert al-danger">âš ï¸ FAULTY â€” Down ${downtimeStr(a.faultyDate)}</div>`:''}
  ${a.photo?`<div style="margin-bottom:14px"><img src="${a.photo}" style="width:100%;max-height:220px;object-fit:cover;border-radius:10px;border:1px solid var(--border)"></div>`:''}
  <div class="frow">
    <div><div class="flbl">Finance Tag</div><div style="font-family:'JetBrains Mono',monospace;color:var(--blue2);font-weight:700;font-size:.9rem">${esc(a.tag)}</div></div>
    <div><div class="flbl">Status</div><span class="pill pill-${statusColor(a.status)}">${esc(a.status)}</span></div>
    <div><div class="flbl">Facility</div><span class="fac-tag fac-${a.facility}">${a.facility}</span></div>
    <div><div class="flbl">Usage Hours</div><div style="font-family:'JetBrains Mono',monospace;color:var(--teal)">${a.usageHours||0}h</div></div>
  </div>
  <div class="frow" style="margin-top:10px">
    <div><div class="flbl">Serial</div><div style="font-size:.78rem;font-family:'JetBrains Mono',monospace">${esc(a.serial||'â€”')}</div></div>
    <div><div class="flbl">Model</div><div>${esc(a.model||'â€”')}</div></div>
    <div><div class="flbl">Location</div><div>${esc(a.location||'â€”')}</div></div>
    <div><div class="flbl">Vendor</div><div>${esc(a.vendor||'â€”')}</div></div>
  </div>
  <div class="frow" style="margin-top:10px">
    <div><div class="flbl">Cost</div><div style="font-family:'JetBrains Mono',monospace;color:var(--yellow)">${fmtMoney(a.cost)}</div></div>
    <div><div class="flbl">NBV</div><div style="font-family:'JetBrains Mono',monospace;color:var(--green)">${fmtMoney(a.nbv)}</div></div>
    <div><div class="flbl">Next Maintenance</div><div>${fmtDate(a.maintenanceDate)}</div></div>
    <div><div class="flbl">Contract Expiry</div><div>${fmtDate(a.contractExpiry)}</div></div>
  </div>
  ${ppm?`<div style="margin-top:12px;background:var(--surface2);border-radius:8px;padding:12px">
    <div class="card-hd" style="margin-bottom:8px">ğŸ¤– Predictive PPM</div>
    <div style="font-size:.77rem;color:var(--t2)">${esc(ppm.message)}</div>
    <div class="pred-bar" style="margin-top:6px"><div class="pred-fill" style="width:${ppm.health}%;background:${ppm.health>60?'var(--green)':ppm.health>30?'var(--yellow)':'var(--red)'}"></div></div>
    <div style="font-size:.66rem;color:var(--t3);margin-top:3px">Equipment Health: ${ppm.health}%</div>
  </div>`:''}`,
  `<button class="btn btn-sec" onclick="closeModal()">Close</button>
   <button class="btn btn-pri" onclick="closeModal();openAssetModal('${id}')">âœï¸ Edit</button>`,'wide');
}

function openMoveAsset(){
  if(!requireStaff())return;
  const options=DB.assets.map(a=>`<option value="${a.id}">[${esc(a.facility)}] ${esc(a.tag)} â€” ${esc(a.name)}</option>`).join('');
  const facOpts=DB.facilities.filter(f=>f.active).map(f=>`<option value="${f.id}" ${f.id===currentFacility?'selected':''}>${f.name}</option>`).join('');
  showModal('Move / Transfer Asset',`
  <div class="alert al-info">Transfers are logged in the audit trail. Select asset and destination facility.</div>
  <div class="fg"><label class="flbl">Select Asset</label><select class="fsel" id="move-asset">${options}</select></div>
  <div class="fg"><label class="flbl">Destination Facility</label><select class="fsel" id="move-dest">${facOpts}</select></div>
  <div class="fg"><label class="flbl">New Location / Bay</label><input class="finput" id="move-loc" placeholder="e.g. Bay A, Lab Bench 3"></div>
  <div class="fg"><label class="flbl">Reason for Transfer</label><textarea class="ftxt" id="move-reason" placeholder="State reason..."></textarea></div>`,
  `<button class="btn btn-sec" onclick="closeModal()">Cancel</button>
   <button class="btn btn-pri" onclick="executeMove()">â†”ï¸ Confirm Transfer</button>`);
}

function executeMove(){
  if(!requireStaff())return;
  const assetId=document.getElementById('move-asset').value;
  const dest=document.getElementById('move-dest').value;
  const loc=document.getElementById('move-loc').value;
  const reason=document.getElementById('move-reason').value;
  const a=DB.assets.find(x=>x.id===assetId);if(!a)return;
  if(a.facility===dest){alert('Asset is already in that facility.');return;}
  const from=a.facility;
  DB.assets=DB.assets.map(x=>x.id===assetId?{...x,facility:dest,location:loc||x.location}:x);
  auditLog('Asset transferred',`${a.tag} from ${from} to ${dest}. Reason: ${reason}`);
  dbSave();closeModal();updateBadges();renderAssets(document.getElementById('page-root'));
  alert(`âœ“ ${a.name} transferred from ${from} to ${dest}.`);
}

function openAssetModal(id){
  if(!requireStaff())return;
  const a=id?DB.assets.find(x=>x.id===id):null;
  const v=k=>a?esc(a[k]||''):'';
  const facOpts=DB.facilities.filter(f=>f.active).map(f=>`<option value="${f.id}" ${(a?a.facility:currentFacility)===f.id?'selected':''}>${f.name}</option>`).join('');
  const hasPhoto=a&&a.photo;
  showModal(id?'Edit Asset':'Add New Asset',`
  <div class="photo-upload-wrap">
    <label class="flbl">Asset Photo</label>
    <div class="photo-preview ${hasPhoto?'has-photo':''}" id="f-photo-preview" onclick="document.getElementById('f-photo-file').click()">
      ${hasPhoto?`<img id="f-photo-img" src="${a.photo}" alt="Asset photo">`:`<img id="f-photo-img" src="" alt="" style="display:none">`}
      <div class="photo-placeholder">
        <div class="photo-placeholder-icon">ğŸ“·</div>
        <div class="photo-placeholder-lbl">Tap to take photo or upload</div>
        <div class="photo-placeholder-sub">Camera Â· Gallery Â· File</div>
      </div>
      <button class="photo-clear" id="f-photo-clear" onclick="clearAssetPhoto(event)" title="Remove photo">âœ•</button>
    </div>
    <div class="photo-actions">
      <label class="btn btn-sec btn-sm" style="cursor:pointer">
        ğŸ“· Camera
        <input type="file" id="f-photo-camera" accept="image/*" capture="environment" style="display:none" onchange="handleAssetPhoto(this)">
      </label>
      <label class="btn btn-sec btn-sm" style="cursor:pointer">
        ğŸ–¼ Gallery
        <input type="file" id="f-photo-file" accept="image/*" style="display:none" onchange="handleAssetPhoto(this)">
      </label>
    </div>
  </div>
  <div class="frow"><div class="fg"><label class="flbl">Asset Name *</label><input class="finput" id="f-name" value="${v('name')}"></div><div class="fg"><label class="flbl">Asset Tag *</label><input class="finput" id="f-tag" value="${v('tag')}"></div></div>
  <div class="frow"><div class="fg"><label class="flbl">Asset Status</label><select class="fsel" id="f-status">${['Active','Faulty','Under Maintenance','Disposed','Withdrawn'].map(s=>`<option ${a&&a.status===s?'selected':''}>${s}</option>`).join('')}</select></div><div class="fg"><label class="flbl">Spend Category</label><select class="fsel" id="f-spend">${['Fixed Asset','LVA'].map(s=>`<option value="${s}" ${a&&a.spendCategory===s?'selected':''}>${s==='LVA'?'Low Value Asset (LVA)':s}</option>`).join('')}</select></div></div>
  <div class="fg" style="margin-bottom:10px"><label class="flbl">Description</label><textarea class="ftxt" id="f-desc" rows="2">${v('description')}</textarea></div>
  <div class="frow"><div class="fg"><label class="flbl">Date Acquired</label><input class="finput" type="date" id="f-acquired" value="${v('dateAcquired')}"></div><div class="fg"><label class="flbl">Serial Number</label><input class="finput" id="f-serial" value="${v('serial')}"></div></div>
  <div class="frow"><div class="fg"><label class="flbl">Asset Cost (SGD)</label><input class="finput" type="number" id="f-cost" value="${a?a.cost:0}"></div><div class="fg"><label class="flbl">Net Book Value (SGD)</label><input class="finput" type="number" id="f-nbv" value="${a?a.nbv:0}"></div></div>
  <div class="frow"><div class="fg"><label class="flbl">Facility</label><select class="fsel" id="f-fac">${facOpts}</select></div><div class="fg"><label class="flbl">Location</label><input class="finput" id="f-location" value="${v('location')}"></div></div>
  <div class="frow"><div class="fg"><label class="flbl">Asset Class</label><input class="finput" id="f-aclass" value="${v('assetClass')}" placeholder="e.g. Machinery & Equipment"></div><div class="fg"><label class="flbl">Asset Type</label><input class="finput" id="f-atype" value="${v('assetType')}" placeholder="e.g. Printing Equipment"></div></div>
  <div class="frow"><div class="fg"><label class="flbl">Model</label><input class="finput" id="f-model" value="${v('model')}"></div><div class="fg"><label class="flbl">Vendor</label><input class="finput" id="f-vendor" value="${v('vendor')}"></div></div>
  <div class="frow"><div class="fg"><label class="flbl">Next Maintenance</label><input class="finput" type="date" id="f-mdate" value="${v('maintenanceDate')}"></div><div class="fg"><label class="flbl">Usage Hours</label><input class="finput" type="number" id="f-hours" value="${a?a.usageHours||0:0}"></div></div>`,
  `<button class="btn btn-sec" onclick="closeModal()">Cancel</button><button class="btn btn-pri" onclick="saveAsset('${id||''}')">ğŸ’¾ Save</button>`,'wide');
}

// Shared photo state for the currently open modal
let _pendingPhoto = null;

function handleAssetPhoto(input){
  const file = input.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    _pendingPhoto = e.target.result;
    const img = document.getElementById('f-photo-img');
    const prev = document.getElementById('f-photo-preview');
    if(img){ img.src = e.target.result; img.style.display='block'; }
    if(prev){ prev.classList.add('has-photo'); }
  };
  reader.readAsDataURL(file);
}

function clearAssetPhoto(e){
  e.stopPropagation();
  _pendingPhoto = '';
  const img = document.getElementById('f-photo-img');
  const prev = document.getElementById('f-photo-preview');
  if(img){ img.src=''; img.style.display='none'; }
  if(prev){ prev.classList.remove('has-photo'); }
}

function saveAsset(id){
  if(!requireStaff())return;
  const name=document.getElementById('f-name').value.trim();
  const tag=document.getElementById('f-tag').value.trim();
  if(!name||!tag){alert('Name and Tag required.');return;}
  // Resolve photo: _pendingPhoto = new image (data URL), '' = cleared, null = unchanged
  const existingAsset = id ? DB.assets.find(a=>a.id===id) : null;
  const photo = _pendingPhoto !== null ? _pendingPhoto : (existingAsset ? existingAsset.photo : null);
  _pendingPhoto = null;
  const asset={name,tag,serial:document.getElementById('f-serial').value.trim(),model:document.getElementById('f-model').value.trim(),facility:document.getElementById('f-fac').value,location:document.getElementById('f-location').value.trim(),cost:parseFloat(document.getElementById('f-cost').value)||0,nbv:parseFloat(document.getElementById('f-nbv').value)||0,status:document.getElementById('f-status').value,spendCategory:document.getElementById('f-spend').value,description:document.getElementById('f-desc').value.trim(),dateAcquired:document.getElementById('f-acquired').value||null,assetClass:document.getElementById('f-aclass').value.trim(),assetType:document.getElementById('f-atype').value.trim(),maintenanceDate:document.getElementById('f-mdate').value||null,vendor:document.getElementById('f-vendor').value.trim(),usageHours:parseFloat(document.getElementById('f-hours').value)||0,photo};
  if(id){DB.assets=DB.assets.map(a=>a.id===id?{...a,...asset}:a);}
  else{DB.assets.push({...asset,id:'A'+Date.now(),faultyDate:null,pinX:50,pinY:50,lastUsed:null});}
  auditLog(id?'Edited asset':'Added asset',tag);
  dbSave();closeModal();updateBadges();renderAssets(document.getElementById('page-root'));
}

function openDisposal(id){
  if(!requireStaff())return;
  const a=DB.assets.find(x=>x.id===id);if(!a)return;
  showModal('Withdrawal / Disposal Request',`
  <div class="alert al-info"><strong>${esc(a.name)}</strong> (${esc(a.tag)}) Â· NBV: ${fmtMoney(a.nbv)}</div>
  <div class="fg"><label class="flbl">Request Type</label><select class="fsel" id="d-type"><option>Withdrawal</option><option>Disposal</option></select></div>
  <div class="fg"><label class="flbl">Effective Date</label><input class="finput" type="date" id="d-date" value="${new Date().toISOString().slice(0,10)}"></div>
  <div class="fg"><label class="flbl">Approver Email</label><input class="finput" id="d-approver" placeholder="approver@school.edu.sg"></div>
  <div class="fg"><label class="flbl">Reason</label><textarea class="ftxt" id="d-reason"></textarea></div>`,
  `<button class="btn btn-sec" onclick="closeModal()">Cancel</button><button class="btn btn-warn" onclick="generateDisposalEmail('${id}')">ğŸ“§ Generate Email</button>`);
}

function generateDisposalEmail(id){
  const a=DB.assets.find(x=>x.id===id);if(!a)return;
  const type=document.getElementById('d-type').value;
  const date=document.getElementById('d-date').value;
  const approver=document.getElementById('d-approver').value||'Manager';
  const reason=document.getElementById('d-reason').value||'â€”';
  const subj=`[${type} Request] ${a.name} â€” ${a.tag}`;
  const body=`Dear ${approver},\n\nRequest for ${type.toLowerCase()} of:\n\nAsset: ${a.name}\nTag: ${a.tag}\nFacility: ${a.facility}\nLocation: ${a.location}\nSerial: ${a.serial||'â€”'}\nModel: ${a.model||'â€”'}\nCost: ${fmtMoney(a.cost)}\nNBV: ${fmtMoney(a.nbv)}\n\nReason: ${reason}\nEffective: ${fmtDate(date)}\n\nRequested by: ${currentStaff?.name||'â€”'}\n\nâ€” Facilities Management`;
  DB.assets=DB.assets.map(x=>x.id===id?{...x,status:type==='Disposal'?'Disposed':'Withdrawn'}:x);
  auditLog(`Generated ${type} request`,a.tag);
  dbSave();closeModal();updateBadges();
  window.location.href=`mailto:?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`;
  renderAssets(document.getElementById('page-root'));
}

function exportAssetChecklist(){
  const fAssets=facAssets();
  const lines=[`ASSET MANAGEMENT CHECKLIST â€” ${currentFacility}`,'='.repeat(50),`Date: ${fmtDate(new Date().toISOString())}`,`Exported by: ${currentStaff?.name||'â€”'}`,``,`Tag\t\tAsset Name\t\t\tSerial\t\t\tLocation\t\t\tStatus\t\t\tNext Maint.\t\tNBV`,'â”€'.repeat(120),...fAssets.map(a=>`${a.tag}\t\t${a.name}\t\t\t${a.serial||'â€”'}\t\t\t${a.location||'â€”'}\t\t\t${a.status}\t\t\t${fmtDate(a.maintenanceDate)}\t\t${fmtMoney(a.nbv)}`)];
  const blob=new Blob([lines.join('\n')],{type:'text/plain'});
  const url=URL.createObjectURL(blob);
  const el=document.createElement('a');el.href=url;el.download=`${currentFacility}_assets_${todayStr()}.txt`;el.click();URL.revokeObjectURL(url);
  auditLog('Exported asset checklist',currentFacility);
}

function downloadCSVTemplate(){
  const headers=['Asset','Asset Status','Spend Category','Asset Name','Description','Date Acquired','Asset Cost','Net Book Value (Posted/Accounted)','Location of Business Asset','Asset Class','Asset Type','Serial Number','Manufacturer','Model'];
  const sample=['T11-FIN-001','Active','Fixed Asset','3D Printer Ultimaker S5','FDM 3D printer for prototyping','2022-03-01','12000','8000','T11C01 Bay A','Machinery & Equipment','Printing Equipment','UM-S5-1234','Ultimaker','S5'];
  const csv=[headers.join(','),sample.join(',')].join('
');
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='FablabFacility_Asset_Template.csv';a.click();URL.revokeObjectURL(url);
}

function importCSV(inp){
  const f=inp.files[0];if(!f)return;
  if(!requireStaff())return;
  const r=new FileReader();
  r.onload=ev=>{
    const lines=ev.target.result.split('\n').filter(Boolean);
    if(lines.length<2){alert('CSV empty.');return;}
    const headers=lines[0].split(',').map(h=>h.trim().toLowerCase().replace(/["']/g,''));
    const imported=lines.slice(1).map((line,i)=>{
      const vals=line.split(',').map(v=>v.trim().replace(/^"|"$/g,''));
      const obj={};headers.forEach((h,idx)=>{obj[h]=vals[idx]||'';});
      const loc=obj['location of business asset']||obj.location||obj['location'']||'';
      const facMatch=DB.facilities.find(f=>loc.toLowerCase().includes(f.id.toLowerCase()))||null;
      return{id:'CSV'+Date.now()+i,
        tag:obj['asset']||obj.tag||obj['asset tag']||obj['finance tag']||'',
        name:obj['asset name']||obj.name||'Unnamed',
        status:obj['asset status']||obj.status||'Active',
        spendCategory:obj['spend category']||obj['spendcategory']||'Fixed Asset',
        description:obj['description']||obj.desc||'',
        dateAcquired:obj['date acquired']||obj['dateacquired']||null,
        cost:parseFloat(obj['asset cost']||obj.cost||0),
        nbv:parseFloat(obj['net book value (posted/accounted)']||obj['net book value']||obj.nbv||0),
        location:loc,
        assetClass:obj['asset class']||obj.assetclass||'',
        assetType:obj['asset type']||obj.assettype||'',
        serial:obj['serial number']||obj.serial||'',
        model:obj.model||'',
        facility:facMatch?facMatch.id:currentFacility,
        vendor:obj.vendor||obj.manufacturer||'',
        maintenanceDate:null,contractExpiry:null,photo:null,faultyDate:null,pinX:50,pinY:50,usageHours:0,lastUsed:null};
    }).filter(a=>a.name&&a.name!=='Unnamed');
    DB.assets=[...DB.assets,...imported];
    auditLog('Imported CSV assets',`${imported.length} assets`);
    dbSave();updateBadges();alert(`âœ“ Imported ${imported.length} assets.`);
    renderAssets(document.getElementById('page-root'));
  };
  r.readAsText(f);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIRST AID
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFirstAid(root){
  const items=facFirstAid().map(i=>({...i,_s:faStatus(i)}));
  const crit=items.filter(i=>i._s==='Critical');
  const exp=items.filter(i=>i._s==='Expiring');
  const low=items.filter(i=>i._s==='Low');
  const ok=items.filter(i=>i._s==='OK');
  root.innerHTML=`
  ${crit.length>0?`<div class="alert al-danger">ğŸš¨ ${crit.length} item(s) CRITICAL in ${currentFacility}</div>`:''}
  <div class="stats-row stats-4">
    <div class="stat-card sc-red"><div class="stat-lbl">Critical</div><div class="stat-val sv-red">${crit.length}</div><div class="stat-sub">Zero/expired</div></div>
    <div class="stat-card sc-orange"><div class="stat-lbl">Expiring</div><div class="stat-val sv-orange">${exp.length}</div><div class="stat-sub">Within 60d</div></div>
    <div class="stat-card sc-yellow"><div class="stat-lbl">Low Stock</div><div class="stat-val sv-yellow">${low.length}</div><div class="stat-sub">Below min</div></div>
    <div class="stat-card sc-green"><div class="stat-lbl">OK</div><div class="stat-val sv-green">${ok.length}</div><div class="stat-sub">Fully stocked</div></div>
  </div>
  <div class="sec-hd">
    <div class="sec-title">First Aid â€” ${currentFacility}</div>
    <div style="display:flex;gap:7px;flex-wrap:wrap">
      <button class="btn btn-warn btn-sm" onclick="exportFAChecklist()" >ğŸ“„ Export Checklist</button>
      <button class="btn btn-warn btn-sm" onclick="generateFAEmail()" ${crit.length+exp.length+low.length===0?'disabled':''}>ğŸ“§ Replenish Email</button>
      <button class="btn btn-pri btn-sm" onclick="openFAModal(null)">+ Add Item</button>
    </div>
  </div>
  <div class="tbl-wrap"><table>
    <thead><tr><th>Item</th><th>Location</th><th>Qty</th><th>Min</th><th>Expiry</th><th>Days</th><th>Status</th><th>Actions</th></tr></thead>
    <tbody>
    ${items.map(item=>{const d=daysUntil(item.expiry);return`<tr>
      <td style="font-weight:600;color:var(--t1)">${esc(item.name)}</td>
      <td>${esc(item.location)}</td>
      <td><span style="font-family:'JetBrains Mono',monospace;font-size:.87rem;font-weight:600;color:${item.qty===0?'var(--red)':item.qty<item.minQty?'var(--yellow)':'var(--t1)'}">${item.qty}</span></td>
      <td style="font-family:'JetBrains Mono',monospace;color:var(--t3)">${item.minQty}</td>
      <td>${fmtDate(item.expiry)}</td>
      <td><span class="pill pill-${d<=0?'red':d<=60?'orange':d<=180?'yellow':'green'}">${d<=0?'EXP':d+'d'}</span></td>
      <td><span class="pill pill-${faColor(item._s)}">${item._s}</span></td>
      <td><div style="display:flex;gap:2px"><button class="btn btn-xs btn-success" onclick="replenishFA('${item.id}')">â†‘ Qty</button><button class="btn btn-xs btn-sec" onclick="openFAModal('${item.id}')">âœï¸</button></div></td>
    </tr>`;}).join('')}
    </tbody>
  </table></div>`;
}

function replenishFA(id){
  if(!requireStaff())return;
  const items=facFirstAid();
  const item=items.find(i=>i.id===id);if(!item)return;
  const v=prompt(`"${item.name}"\nCurrent: ${item.qty}\nNew quantity:`,item.qty);
  if(v===null)return;
  const qty=parseInt(v);if(isNaN(qty)||qty<0){alert('Invalid qty');return;}
  DB.firstAid[currentFacility]=DB.firstAid[currentFacility].map(i=>i.id===id?{...i,qty}:i);
  auditLog('Updated first aid qty',`${item.name}: ${item.qty} â†’ ${qty}`);
  dbSave();updateBadges();renderFirstAid(document.getElementById('page-root'));
}
function openFAModal(id){
  if(!requireStaff())return;
  const item=id?facFirstAid().find(i=>i.id===id):null;
  const v=k=>item?esc(item[k]||''):'';
  showModal(id?'Edit Item':'Add First Aid Item',`
  <div class="fg"><label class="flbl">Item Name</label><input class="finput" id="fa-name" value="${v('name')}"></div>
  <div class="fg"><label class="flbl">Location</label><select class="fsel" id="fa-loc">${['Cabinet A','Cabinet B','Reception','Lab','Other'].map(l=>`<option ${item&&item.location===l?'selected':''}>${l}</option>`).join('')}</select></div>
  <div class="frow"><div class="fg"><label class="flbl">Qty</label><input class="finput" type="number" min="0" id="fa-qty" value="${item?item.qty:0}"></div><div class="fg"><label class="flbl">Min Qty</label><input class="finput" type="number" min="1" id="fa-min" value="${item?item.minQty:2}"></div></div>
  <div class="fg"><label class="flbl">Expiry Date</label><input class="finput" type="date" id="fa-exp" value="${v('expiry')}"></div>`,
  `<button class="btn btn-sec" onclick="closeModal()">Cancel</button><button class="btn btn-pri" onclick="saveFA('${id||''}')">Save</button>`);
}
function saveFA(id){
  if(!requireStaff())return;
  const name=document.getElementById('fa-name').value.trim();
  if(!name){alert('Name required');return;}
  const obj={name,location:document.getElementById('fa-loc').value,qty:parseInt(document.getElementById('fa-qty').value)||0,minQty:parseInt(document.getElementById('fa-min').value)||1,expiry:document.getElementById('fa-exp').value};
  if(!DB.firstAid[currentFacility])DB.firstAid[currentFacility]=[];
  if(id){DB.firstAid[currentFacility]=DB.firstAid[currentFacility].map(i=>i.id===id?{...i,...obj}:i);}
  else{DB.firstAid[currentFacility].push({...obj,id:'fa-'+currentFacility+'-'+Date.now()});}
  auditLog(id?'Edited first aid item':'Added first aid item',name);
  dbSave();closeModal();updateBadges();renderFirstAid(document.getElementById('page-root'));
}
function generateFAEmail(){
  const need=facFirstAid().filter(i=>faStatus(i)!=='OK');
  const lines=need.map(i=>`â€¢ ${i.name}\n  Qty: ${i.qty}/${i.minQty} | ${i.location} | Expiry: ${fmtDate(i.expiry)} | ${faStatus(i)}`);
  const subj=`[First Aid Replenishment] ${currentFacility} â€” ${fmtDate(new Date().toISOString())}`;
  const body=`Dear Team,\n\nPlease replenish the following first aid items at ${currentFacility}:\n\n${lines.join('\n\n')}\n\nRequested by: ${currentStaff?.name||'â€”'}\nâ€” Facilities Management`;
  window.location.href=`mailto:?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`;
  auditLog('Generated FA replenishment email',currentFacility);
}
function exportFAChecklist(){
  const items=facFirstAid();
  const lines=[`FIRST AID CHECKLIST â€” ${currentFacility}`,'='.repeat(50),`Date: ${fmtDate(new Date().toISOString())}`,`Checked by: ${currentStaff?.name||'â€”'}`,``,`Item\t\t\t\t\tQty\tMin\tLocation\tExpiry\t\t\tStatus`,'â”€'.repeat(90),...items.map(i=>`${i.name}\t\t\t${i.qty}\t${i.minQty}\t${i.location}\t\t${fmtDate(i.expiry)}\t\t${faStatus(i)}`)];
  const blob=new Blob([lines.join('\n')],{type:'text/plain'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=`${currentFacility}_firstaid_${todayStr()}.txt`;a.click();URL.revokeObjectURL(url);
  auditLog('Exported first aid checklist',currentFacility);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAINTENANCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMaintenance(root){
  const fAssets=facAssets();
  const faulty=fAssets.filter(a=>a.status==='Faulty');
  const upcoming=fAssets.filter(a=>a.maintenanceDate&&daysUntil(a.maintenanceDate)<=60).sort((a,b)=>new Date(a.maintenanceDate)-new Date(b.maintenanceDate));
  root.innerHTML=`
  <div class="stats-row stats-4">
    <div class="stat-card sc-red"><div class="stat-lbl">Faulty Now</div><div class="stat-val sv-red">${faulty.length}</div><div class="stat-sub">Down</div></div>
    <div class="stat-card sc-yellow"><div class="stat-lbl">Due (60d)</div><div class="stat-val sv-yellow">${upcoming.length}</div><div class="stat-sub">Maint.</div></div>
    <div class="stat-card sc-purple"><div class="stat-lbl">All Assets</div><div class="stat-val sv-purple">${fAssets.length}</div><div class="stat-sub">${currentFacility}</div></div>
    <div class="stat-card sc-teal"><div class="stat-lbl">Avg Usage</div><div class="stat-val sv-teal">${(fAssets.reduce((s,a)=>s+(a.usageHours||0),0)/Math.max(fAssets.length,1)).toFixed(0)}h</div><div class="stat-sub">Per asset</div></div>
  </div>
  <div class="tabs">
    <button class="tab-btn ${maintTab==='upcoming'?'active':''}" onclick="maintTab='upcoming';renderMaintenance(document.getElementById('page-root'))">ğŸ”§ Schedule</button>
    <button class="tab-btn ${maintTab==='faulty'?'active':''}" onclick="maintTab='faulty';renderMaintenance(document.getElementById('page-root'))">âš ï¸ Faults (${faulty.length})</button>
    <button class="tab-btn ${maintTab==='log'?'active':''}" onclick="maintTab='log';renderMaintenance(document.getElementById('page-root'))">ğŸ“‹ Maintenance Log</button>
    <button class="tab-btn ${maintTab==='teams'?'active':''}" onclick="maintTab='teams';renderMaintenance(document.getElementById('page-root'))">âš™ï¸ Teams</button>
  </div>
  <div id="maint-content"></div>`;
  renderMaintContent();
}

function renderMaintContent(){
  const el=document.getElementById('maint-content');if(!el)return;
  const fAssets=facAssets();
  if(maintTab==='upcoming'){
    const upcoming=fAssets.filter(a=>a.maintenanceDate&&daysUntil(a.maintenanceDate)<=60).sort((a,b)=>new Date(a.maintenanceDate)-new Date(b.maintenanceDate));
    el.innerHTML=upcoming.length===0?`<div class="empty"><div class="empty-icon">âœ…</div><div>No maintenance due in 60 days</div></div>`
    :`<div class="tbl-wrap"><table><thead><tr><th>Tag</th><th>Asset</th><th>Location</th><th>Due</th><th>Days</th><th>Usage Hrs</th><th>Vendor</th><th>Status</th></tr></thead><tbody>
    ${upcoming.map(a=>{const d=daysUntil(a.maintenanceDate);return`<tr>
      <td style="font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--blue2)">${esc(a.tag)}</td>
      <td style="font-weight:600;color:var(--t1)">${esc(a.name)}</td>
      <td>${esc(a.location)}</td><td>${fmtDate(a.maintenanceDate)}</td>
      <td><span class="pill pill-${d<=7?'red':d<=30?'orange':'yellow'}">${d}d</span></td>
      <td style="font-family:'JetBrains Mono',monospace;color:var(--teal)">${a.usageHours||0}h</td>
      <td>${esc(a.vendor||'â€”')}</td>
      <td><span class="pill pill-${statusColor(a.status)}">${esc(a.status)}</span></td>
    </tr>`;}).join('')}
    </tbody></table></div>`;
  } else if(maintTab==='faulty'){
    const faulty=fAssets.filter(a=>a.status==='Faulty');
    let html=faulty.length===0?`<div class="empty"><div class="empty-icon">âœ…</div><div>All equipment operational</div></div>`
    :faulty.map(a=>`<div class="card" style="margin-bottom:9px;border-color:rgba(239,68,68,.3)">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div><div style="font-weight:700;color:var(--red)">ğŸ”´ ${esc(a.name)}</div><div style="font-size:.74rem;color:var(--t2);margin-top:3px">${esc(a.tag)} Â· ${esc(a.location)}</div>
          <div style="margin-top:8px"><div style="font-size:.62rem;color:var(--t3);text-transform:uppercase;letter-spacing:.08em">DOWNTIME</div><div style="font-family:'JetBrains Mono',monospace;font-size:1.2rem;color:var(--red);font-weight:500">${downtimeStr(a.faultyDate)}</div><div style="font-size:.68rem;color:var(--t3)">Since ${fmtDate(a.faultyDate)}</div></div>
        </div>
        <div style="display:flex;gap:7px;flex-direction:column">
          <button class="btn btn-success btn-sm" onclick="clearFaultMaint('${a.id}')">âœ“ Restored</button>
          <button class="btn btn-danger btn-sm" onclick="notifyTeams('${a.id}')">ğŸ“¢ Notify Teams</button>
          <button class="btn btn-sec btn-sm" onclick="logMaintenanceAction('${a.id}')">ğŸ“ Log Action</button>
        </div>
      </div>
    </div>`).join('');
    html+=`<div style="margin-top:16px"><div class="card-hd" style="margin-bottom:8px">All Assets â€” Quick Fault</div>
    <div class="tbl-wrap"><table><thead><tr><th>Tag</th><th>Asset</th><th>Location</th><th>Status</th><th>Action</th></tr></thead><tbody>
    ${fAssets.filter(a=>a.status!=='Disposed'&&a.status!=='Withdrawn').map(a=>`<tr>
      <td style="font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--blue2)">${esc(a.tag)}</td>
      <td>${esc(a.name)}</td><td>${esc(a.location)}</td>
      <td><span class="pill pill-${statusColor(a.status)}">${esc(a.status)}</span></td>
      <td>${a.status==='Faulty'
        ?`<button class="btn btn-xs btn-success" onclick="clearFaultMaint('${a.id}')">âœ“ Restore</button>`
        :`<button class="btn btn-xs btn-danger" onclick="markFaultyMaint('${a.id}')">âš ï¸ Fault</button>`}</td>
    </tr>`).join('')}</tbody></table></div></div>`;
    el.innerHTML=html;
  } else if(maintTab==='log'){
    const logs=DB.maintenance.filter(m=>m.facility===currentFacility).slice(0,20);
    el.innerHTML=`<div class="sec-hd"><div class="sec-title">Maintenance Records</div><button class="btn btn-pri btn-sm" onclick="logMaintenanceAction(null)">+ Log Entry</button></div>
    ${logs.length===0?`<div class="empty"><div class="empty-icon">ğŸ“‹</div><div>No maintenance records yet</div></div>`
    :`<div class="tbl-wrap"><table><thead><tr><th>Date</th><th>Asset</th><th>Type</th><th>Technician</th><th>Notes</th><th>Status</th></tr></thead><tbody>
    ${logs.map(m=>`<tr>
      <td style="font-family:'JetBrains Mono',monospace;font-size:.7rem">${fmtDate(m.date)}</td>
      <td>${esc(m.assetName)}</td><td><span class="pill pill-blue">${esc(m.type)}</span></td>
      <td>${esc(m.technician)}</td><td style="max-width:200px;white-space:normal">${esc(m.notes)}</td>
      <td><span class="pill pill-${m.resolved?'green':'yellow'}">${m.resolved?'Resolved':'Pending'}</span></td>
    </tr>`).join('')}
    </tbody></table></div>`}`;
  } else if(maintTab==='teams'){
    el.innerHTML=`<div class="card"><div class="card-hd">ğŸ“¢ MS Teams Webhook</div>
    <div class="alert al-info">Equipment fault/restore events post automatically to your Teams channel.</div>
    <div class="fg"><label class="flbl">Webhook URL</label><input class="finput" id="teams-wh" value="${esc(DB.teamsWebhook)}" placeholder="https://yourorg.webhook.office.com/..." oninput="DB.teamsWebhook=this.value;dbSave()"></div>
    <div style="font-size:.75rem;color:var(--t3);line-height:2;margin-bottom:12px">Teams â†’ Channel â†’ Â·Â·Â· â†’ Connectors â†’ Incoming Webhook â†’ Copy URL</div>
    <button class="btn btn-sec btn-sm" onclick="testTeams()">Test Notification</button></div>`;
  }
}

function markFaultyMaint(id){
  if(!requireStaff())return;
  DB.assets=DB.assets.map(a=>a.id===id?{...a,status:'Faulty',faultyDate:new Date().toISOString()}:a);
  const a=DB.assets.find(x=>x.id===id);
  auditLog('Marked faulty (maintenance)',a?.tag||id);
  sendTeamsMsg(a,'down');dbSave();updateBadges();renderMaintenance(document.getElementById('page-root'));
}
function clearFaultMaint(id){
  if(!requireStaff())return;
  const a=DB.assets.find(x=>x.id===id);
  DB.assets=DB.assets.map(x=>x.id===id?{...x,status:'Active',faultyDate:null}:x);
  auditLog('Cleared fault (maintenance)',a?.tag||id);
  sendTeamsMsg(a,'up');dbSave();updateBadges();renderMaintenance(document.getElementById('page-root'));
}
function notifyTeams(id){const a=DB.assets.find(x=>x.id===id);sendTeamsMsg(a,'down');}
function testTeams(){sendTeamsMsg({name:'Test Equipment',tag:'TEST-001',location:currentFacility},'down');}

function sendTeamsMsg(a,state){
  const wh=DB.teamsWebhook;
  const isDown=state==='down';
  const title=isDown?`ğŸ”´ FAULT: ${a?.name}`:`âœ… RESTORED: ${a?.name}`;
  if(!wh){alert(`[DEMO â€” Teams not configured]\n\n${title}\nTag: ${a?.tag}\nFacility: ${a?.facility||currentFacility}\n\nConfigure webhook in Maintenance â†’ Teams.`);return;}
  const msg={"@type":"MessageCard","@context":"https://schema.org/extensions","themeColor":isDown?"FF0000":"00B050","summary":title,"sections":[{"activityTitle":title,"facts":[{"name":"Tag","value":a?.tag||'â€”'},{"name":"Facility","value":a?.facility||currentFacility},{"name":"Status","value":isDown?`FAULTY â€” ${new Date().toLocaleString()}`:`Restored â€” ${new Date().toLocaleString()}`},{"name":"Reported By","value":currentStaff?.name||'System'}]}]};
  fetch(wh,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(msg)}).then(()=>alert('âœ“ Teams notified')).catch(e=>alert('Teams error: '+e.message));
}

function logMaintenanceAction(assetId){
  if(!requireStaff())return;
  const assetOpts=facAssets().map(a=>`<option value="${a.id}" ${a.id===assetId?'selected':''}>${esc(a.tag)} â€” ${esc(a.name)}</option>`).join('');
  showModal('Log Maintenance Action',`
  <div class="fg"><label class="flbl">Asset</label><select class="fsel" id="ml-asset">${assetOpts}</select></div>
  <div class="frow">
    <div class="fg"><label class="flbl">Type</label><select class="fsel" id="ml-type"><option>Corrective</option><option>Preventive</option><option>Calibration</option><option>Inspection</option></select></div>
    <div class="fg"><label class="flbl">Date</label><input class="finput" type="date" id="ml-date" value="${todayStr()}"></div>
  </div>
  <div class="fg"><label class="flbl">Technician</label><input class="finput" id="ml-tech" value="${currentStaff?.name||''}"></div>
  <div class="fg"><label class="flbl">Notes / Actions Taken</label><textarea class="ftxt" id="ml-notes"></textarea></div>
  <div class="fg"><label class="flbl">Resolved?</label><select class="fsel" id="ml-res"><option value="true">Yes â€” Issue Resolved</option><option value="false">No â€” Still Pending</option></select></div>`,
  `<button class="btn btn-sec" onclick="closeModal()">Cancel</button><button class="btn btn-pri" onclick="saveMaintenanceLog()">ğŸ’¾ Save</button>`);
}
function saveMaintenanceLog(){
  const a=DB.assets.find(x=>x.id===document.getElementById('ml-asset').value);
  const rec={id:'ML'+Date.now(),facility:currentFacility,assetId:a?.id||'',assetName:a?.name||'',type:document.getElementById('ml-type').value,date:document.getElementById('ml-date').value,technician:document.getElementById('ml-tech').value,notes:document.getElementById('ml-notes').value,resolved:document.getElementById('ml-res').value==='true',loggedBy:currentStaff?.name||'',loggedAt:new Date().toISOString()};
  DB.maintenance=[rec,...DB.maintenance];
  auditLog('Logged maintenance action',`${a?.tag||''} â€” ${rec.type}`);
  dbSave();closeModal();renderMaintenance(document.getElementById('page-root'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ANALYTICS & PPM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getPPMPrediction(asset){
  const settings=DB.ppmSettings[asset.id]||{maxHours:1000,alertAtPct:80};
  const usedPct=Math.round((asset.usageHours||0)/settings.maxHours*100);
  const health=Math.max(0,100-usedPct);
  let message='';
  if(health<20)message=`âš ï¸ Critical â€” ${asset.usageHours}h used of ${settings.maxHours}h limit. Immediate maintenance required.`;
  else if(health<40)message=`ğŸŸ¡ Warning â€” ${asset.usageHours}h used. Schedule maintenance soon (${settings.maxHours-asset.usageHours}h remaining).`;
  else if(health<60)message=`ğŸŸ  Monitor â€” ${asset.usageHours}h used. PM due in ~${settings.maxHours-asset.usageHours}h.`;
  else message=`âœ… Good â€” ${asset.usageHours}h used of ${settings.maxHours}h limit. Next PM at ${settings.alertAtPct}% (${Math.round(settings.maxHours*settings.alertAtPct/100)}h).`;
  return{health,usedPct,message,settings};
}

function renderAnalytics(root){
  const fAssets=facAssets();
  const last30=[];
  for(let i=29;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);last30.push(d.toISOString().slice(0,10));}

  // Fault events per day (from audit log)
  const faultByDay={};
  last30.forEach(d=>{faultByDay[d]=0;});
  DB.auditLog.filter(l=>l.action.includes('faulty')&&l.facility===currentFacility).forEach(l=>{const d=l.ts.slice(0,10);if(faultByDay[d]!==undefined)faultByDay[d]++;});
  const maxFault=Math.max(...Object.values(faultByDay),1);

  // Usage by asset
  const usageData=fAssets.map(a=>{
    const recent=DB.usageLog.filter(u=>u.assetId===a.id&&u.date>=last30[0]).reduce((s,u)=>s+u.hours,0);
    return{...a,recentHours:+recent.toFixed(1)};
  }).sort((a,b)=>b.recentHours-a.recentHours);

  root.innerHTML=`
  <div class="tabs">
    <button class="tab-btn active">ğŸ“‰ Equipment Downtime</button>
    <button class="tab-btn" onclick="showUsageTab()">â± Usage & PPM</button>
    <button class="tab-btn" onclick="showPPMSettings()">âš™ï¸ PPM Settings</button>
  </div>
  <div class="sec-hd"><div class="sec-title">Equipment Fault Rate â€” Last 30 Days (${currentFacility})</div></div>
  <div class="card" style="margin-bottom:16px">
    <div style="display:flex;align-items:flex-end;gap:3px;height:120px;overflow-x:auto">
      ${last30.map(d=>{
        const v=faultByDay[d];const h=v===0?4:Math.max(8,Math.round(v/maxFault*100));
        const lbl=d.slice(5); // MM-DD
        return`<div style="display:flex;flex-direction:column;align-items:center;gap:3px;min-width:28px;flex:1">
          <div style="height:90px;display:flex;align-items:flex-end;width:100%">
            <div title="${d}: ${v} fault(s)" style="width:100%;height:${h}px;background:${v>0?'var(--red)':'var(--surface3)'};border-radius:3px 3px 0 0;cursor:pointer;transition:background .15s"></div>
          </div>
          <div style="font-size:.52rem;color:var(--t3);font-family:'JetBrains Mono',monospace;transform:rotate(-45deg);transform-origin:top left;white-space:nowrap">${lbl}</div>
        </div>`;
      }).join('')}
    </div>
    <div style="margin-top:10px;font-size:.72rem;color:var(--t3);text-align:center">Fault events per day Â· Red bars = faults reported</div>
  </div>
  <div class="g2">
    <div class="card">
      <div class="card-hd">All-Facilities Fault Summary</div>
      ${DB.facilities.filter(f=>f.active).map(f=>{
        const fa=DB.assets.filter(a=>a.facility===f.id&&a.status==='Faulty').length;
        const total=DB.assets.filter(a=>a.facility===f.id).length;
        const pct=total>0?Math.round(fa/total*100):0;
        return`<div class="card-row"><span class="fac-tag fac-${f.id}">${f.id}</span><div style="flex:1;margin:0 10px"><div class="pred-bar"><div class="pred-fill" style="width:${pct}%;background:${fa>0?'var(--red)':'var(--green)'}"></div></div></div><span style="font-family:'JetBrains Mono',monospace;font-size:.72rem;color:${fa>0?'var(--red)':'var(--green)'}">${fa}/${total}</span></div>`;
      }).join('')}
    </div>
    <div class="card">
      <div class="card-hd">Equipment Health (PPM)</div>
      ${fAssets.slice(0,5).map(a=>{const p=getPPMPrediction(a);return`<div style="margin-bottom:8px"><div style="display:flex;justify-content:space-between;font-size:.73rem;margin-bottom:3px"><span style="color:var(--t1);font-weight:500">${esc(a.name).substring(0,28)}</span><span style="font-family:'JetBrains Mono',monospace;font-size:.67rem;color:${p.health>60?'var(--green)':p.health>30?'var(--yellow)':'var(--red)'}">${p.health}%</span></div><div class="pred-bar"><div class="pred-fill" style="width:${p.health}%;background:${p.health>60?'var(--green)':p.health>30?'var(--yellow)':'var(--red)'}"></div></div></div>`;}).join('')}
    </div>
  </div>
  <div style="margin-top:16px">
    <div class="sec-title" style="margin-bottom:12px">Usage Overview (30 days)</div>
    <div class="tbl-wrap"><table><thead><tr><th>Asset</th><th>Facility</th><th>30d Usage</th><th>Total Hours</th><th>Health</th><th>PPM Status</th><th>Rec. Action</th></tr></thead><tbody>
    ${usageData.map(a=>{const p=getPPMPrediction(a);return`<tr>
      <td style="font-weight:600;color:var(--t1)">${esc(a.name)}</td>
      <td><span class="fac-tag fac-${a.facility}">${a.facility}</span></td>
      <td style="font-family:'JetBrains Mono',monospace;color:var(--teal)">${a.recentHours}h</td>
      <td style="font-family:'JetBrains Mono',monospace">${a.usageHours||0}h</td>
      <td><div style="width:80px"><div class="pred-bar"><div class="pred-fill" style="width:${p.health}%;background:${p.health>60?'var(--green)':p.health>30?'var(--yellow)':'var(--red)'}"></div></div></div></td>
      <td><span class="pill pill-${p.health>60?'green':p.health>30?'yellow':'red'}">${p.health>60?'Good':p.health>30?'Monitor':'Critical'}</span></td>
      <td style="font-size:.72rem;color:var(--t3);max-width:160px;white-space:normal">${p.health<40?'Schedule PM soon':p.health<70?'Monitor closely':'Operational'}</td>
    </tr>`;}).join('')}
    </tbody></table></div>
  </div>`;
}

function showUsageTab(){
  // Reload analytics with usage view
  renderAnalytics(document.getElementById('page-root'));
}

function showPPMSettings(){
  const fAssets=facAssets();
  const rows=fAssets.map(a=>{
    const s=DB.ppmSettings[a.id]||{maxHours:1000,alertAtPct:80};
    return`<tr>
      <td style="font-weight:500;color:var(--t1)">${esc(a.name)}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:.72rem;color:var(--teal)">${a.usageHours||0}h</td>
      <td><input type="number" class="finput" style="width:90px;padding:5px 8px;font-size:.75rem" value="${s.maxHours}" onchange="savePPMSetting('${a.id}','maxHours',this.value)"></td>
      <td><input type="number" class="finput" style="width:70px;padding:5px 8px;font-size:.75rem" min="50" max="100" value="${s.alertAtPct}" onchange="savePPMSetting('${a.id}','alertAtPct',this.value)">%</td>
      <td><span class="pill pill-${getPPMPrediction(a).health>60?'green':getPPMPrediction(a).health>30?'yellow':'red'}">${getPPMPrediction(a).health}%</span></td>
    </tr>`;
  }).join('');
  showModal('PPM Settings',`
  <div class="alert al-info">Configure usage-based predictive maintenance thresholds per asset. Staff will be alerted when usage reaches the alert threshold.</div>
  <div class="tbl-wrap"><table><thead><tr><th>Asset</th><th>Current Usage</th><th>Max Hours (PM)</th><th>Alert At</th><th>Health</th></tr></thead><tbody>${rows}</tbody></table></div>`,
  `<button class="btn btn-sec" onclick="closeModal()">Close</button>`,'wide');
}
function savePPMSetting(assetId,key,val){
  if(!DB.ppmSettings[assetId])DB.ppmSettings[assetId]={maxHours:1000,alertAtPct:80};
  DB.ppmSettings[assetId][key]=parseFloat(val);
  dbSave();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHEMICALS SAFETY DATA SHEET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function facChemicals(){
  if(!DB.chemicals[currentFacility])DB.chemicals[currentFacility]=[];
  return DB.chemicals[currentFacility];
}
function renderChemicals(root){
  const items=facChemicals();
  root.innerHTML=`
  <div class="sec-hd">
    <div class="sec-title">ğŸ§ª Chemicals Safety Data Sheet â€” ${currentFacility}</div>
    <div style="display:flex;gap:7px;flex-wrap:wrap">
      <button class="btn btn-sec btn-sm" onclick="exportChemicalsSDS()">ğŸ“„ Export SDS List</button>
      <button class="btn btn-pri btn-sm" onclick="openChemicalModal(null)">+ Add Chemical</button>
    </div>
  </div>
  <div class="alert al-info">ğŸ“‹ Maintain an up-to-date register of all hazardous chemicals used in ${currentFacility}. Attach SDS documents and ensure all staff are briefed on hazards.</div>
  <div class="tbl-wrap"><table>
    <thead><tr><th>Chemical Name</th><th>CAS No.</th><th>Hazard Class</th><th>Location Stored</th><th>Qty</th><th>Unit</th><th>SDS Ref</th><th>Last Reviewed</th><th>Reviewed By</th><th>Actions</th></tr></thead>
    <tbody>
    ${items.length===0?`<tr><td colspan="10"><div class="empty"><div class="empty-icon">ğŸ§ª</div><div>No chemicals registered. Add chemicals to maintain your SDS register.</div></div></td></tr>`
    :items.map(c=>`<tr>
      <td><div style="font-weight:600;color:var(--t1)">${esc(c.name)}</div>${c.synonyms?`<div style="font-size:.7rem;color:var(--t3)">${esc(c.synonyms)}</div>`:'' }</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:.74rem">${esc(c.cas||'â€”')}</td>
      <td><span class="pill pill-${c.hazardClass==='Flammable'?'orange':c.hazardClass==='Corrosive'?'red':c.hazardClass==='Toxic'?'purple':c.hazardClass==='Oxidising'?'yellow':'blue'}">${esc(c.hazardClass||'â€”')}</span></td>
      <td>${esc(c.location||'â€”')}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-weight:600">${c.qty||'â€”'}</td>
      <td>${esc(c.unit||'')}</td>
      <td style="font-size:.78rem;color:var(--blue2)">${c.sdsRef?`<a href="${esc(c.sdsRef)}" target="_blank" style="color:var(--fac2)">ğŸ“ View SDS</a>`:'â€”'}</td>
      <td style="font-size:.74rem;font-family:'JetBrains Mono',monospace">${fmtDate(c.lastReviewed)}</td>
      <td style="font-size:.78rem">${esc(c.reviewedBy||'â€”')}</td>
      <td><div style="display:flex;gap:3px">
        <button class="btn btn-xs btn-sec" onclick="openChemicalModal('${c.id}')">âœï¸</button>
        <button class="btn btn-xs btn-danger" onclick="deleteChemical('${c.id}')">ğŸ—‘</button>
      </div></td>
    </tr>`).join('')}
    </tbody>
  </table></div>`;
}
function openChemicalModal(id){
  if(!requireStaff())return;
  const c=id?facChemicals().find(x=>x.id===id):null;
  const v=k=>c?esc(c[k]||''):'';
  showModal(id?'Edit Chemical':'Add Chemical / SDS Entry',`
  <div class="frow"><div class="fg"><label class="flbl">Chemical Name *</label><input class="finput" id="ch-name" value="${v('name')}"></div><div class="fg"><label class="flbl">CAS Number</label><input class="finput" id="ch-cas" value="${v('cas')}" placeholder="e.g. 67-64-1"></div></div>
  <div class="fg" style="margin-bottom:10px"><label class="flbl">Synonyms / Trade Name</label><input class="finput" id="ch-syn" value="${v('synonyms')}"></div>
  <div class="frow"><div class="fg"><label class="flbl">Hazard Class</label><select class="fsel" id="ch-hazard">${['Flammable','Corrosive','Toxic','Oxidising','Irritant','Carcinogenic','Environmental Hazard','Non-Hazardous'].map(h=>`<option ${c&&c.hazardClass===h?'selected':''}>${h}</option>`).join('')}</select></div><div class="fg"><label class="flbl">Location Stored</label><input class="finput" id="ch-loc" value="${v('location')}"></div></div>
  <div class="frow"><div class="fg"><label class="flbl">Quantity</label><input class="finput" type="number" id="ch-qty" value="${c?c.qty||'':''}" placeholder="0"></div><div class="fg"><label class="flbl">Unit</label><select class="fsel" id="ch-unit">${['L','mL','kg','g','bottle','drum','container'].map(u=>`<option ${c&&c.unit===u?'selected':''}>${u}</option>`).join('')}</select></div></div>
  <div class="fg" style="margin-bottom:10px"><label class="flbl">SDS Document URL / Reference</label><input class="finput" id="ch-sds" value="${v('sdsRef')}" placeholder="https://... or local reference code"></div>
  <div class="frow"><div class="fg"><label class="flbl">Last Reviewed Date</label><input class="finput" type="date" id="ch-reviewed" value="${v('lastReviewed')}"></div><div class="fg"><label class="flbl">Reviewed By</label><input class="finput" id="ch-by" value="${currentStaff?.name||v('reviewedBy')}"></div></div>
  <div class="fg" style="margin-bottom:10px"><label class="flbl">Notes / Special Precautions</label><textarea class="ftxt" id="ch-notes" rows="2">${v('notes')}</textarea></div>`,
  `<button class="btn btn-sec" onclick="closeModal()">Cancel</button><button class="btn btn-pri" onclick="saveChemical('${id||''}')">ğŸ’¾ Save</button>`,'wide');
}
function saveChemical(id){
  if(!requireStaff())return;
  const name=document.getElementById('ch-name').value.trim();
  if(!name){alert('Chemical name required.');return;}
  const obj={name,cas:document.getElementById('ch-cas').value.trim(),synonyms:document.getElementById('ch-syn').value.trim(),hazardClass:document.getElementById('ch-hazard').value,location:document.getElementById('ch-loc').value.trim(),qty:parseFloat(document.getElementById('ch-qty').value)||0,unit:document.getElementById('ch-unit').value,sdsRef:document.getElementById('ch-sds').value.trim(),lastReviewed:document.getElementById('ch-reviewed').value||null,reviewedBy:document.getElementById('ch-by').value.trim(),notes:document.getElementById('ch-notes').value.trim()};
  const arr=facChemicals();
  if(id){DB.chemicals[currentFacility]=arr.map(c=>c.id===id?{...c,...obj}:c);}
  else{if(!DB.chemicals[currentFacility])DB.chemicals[currentFacility]=[];DB.chemicals[currentFacility].push({...obj,id:'CH'+Date.now()});}
  auditLog(id?'Edited chemical SDS':'Added chemical SDS',name);
  dbSave();closeModal();renderChemicals(document.getElementById('page-root'));
}
function deleteChemical(id){
  const c=facChemicals().find(x=>x.id===id);if(!c)return;
  if(!confirm(`Remove "${c.name}" from the SDS register?`))return;
  DB.chemicals[currentFacility]=facChemicals().filter(x=>x.id!==id);
  auditLog('Deleted chemical SDS',c.name);
  dbSave();renderChemicals(document.getElementById('page-root'));
}
function exportChemicalsSDS(){
  const items=facChemicals();
  const lines=[`CHEMICALS SAFETY DATA SHEET REGISTER â€” ${currentFacility}`,'='.repeat(60),`Date: ${fmtDate(new Date().toISOString())}`,`Exported by: ${currentStaff?.name||'â€”'}`,`Total chemicals: ${items.length}`,``,`Chemical Name	CAS No.	Hazard Class	Location	Qty	Unit	SDS Ref	Last Reviewed	Reviewed By`,'â”€'.repeat(100),...items.map(c=>`${c.name}	${c.cas||'â€”'}	${c.hazardClass||'â€”'}	${c.location||'â€”'}	${c.qty||'â€”'}	${c.unit||'â€”'}	${c.sdsRef||'â€”'}	${fmtDate(c.lastReviewed)}	${c.reviewedBy||'â€”'}`)];
  const blob=new Blob([lines.join('
')],{type:'text/plain'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=`${currentFacility}_chemicals_SDS_${todayStr()}.txt`;a.click();URL.revokeObjectURL(url);
  auditLog('Exported chemicals SDS list',currentFacility);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STAFF MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderStaff(root){
  root.innerHTML=`
  <div class="sec-hd"><div class="sec-title">Staff Management</div><button class="btn btn-pri btn-sm" onclick="openStaffModal(null)">+ Add Staff</button></div>
  <div class="tbl-wrap"><table><thead><tr><th>Name</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead><tbody>
  ${DB.staff.map(s=>`<tr>
    <td style="font-weight:600;color:var(--t1)">${esc(s.name)}</td>
    <td>${esc(s.role)}</td>
    <td><span class="pill pill-${s.active?'green':'red'}">${s.active?'Active':'Inactive'}</span></td>
    <td><div style="display:flex;gap:4px">
      <button class="btn btn-xs btn-sec" onclick="openStaffModal('${s.id}')">âœï¸ Edit</button>
      <button class="btn btn-xs btn-${s.active?'danger':'success'}" onclick="toggleStaff('${s.id}')">${s.active?'Deactivate':'Activate'}</button>
      <button class="btn btn-xs btn-danger" onclick="deleteStaff('${s.id}')" title="Permanently remove">ğŸ—‘</button>
    </div></td>
  </tr>`).join('')}
  </tbody></table></div>
  <div style="margin-top:16px;padding:12px;background:var(--surface2);border-radius:8px;font-size:.75rem;color:var(--t3)">
    <strong style="color:var(--t2)">Note:</strong> All staff appear in the sign-in bar at the top. Every action (checklist submissions, asset changes, fault reports) is logged with the signed-in staff member's name and timestamp.
  </div>`;
}
function openStaffModal(id){
  const s=id?DB.staff.find(x=>x.id===id):null;
  showModal(id?'Edit Staff':'Add Staff Member',`
  <div class="fg"><label class="flbl">Full Name</label><input class="finput" id="sm-name" value="${esc(s?.name||'')}"></div>
  <div class="fg"><label class="flbl">Role / Position</label><input class="finput" id="sm-role" value="${esc(s?.role||'')}"></div>`,
  `<button class="btn btn-sec" onclick="closeModal()">Cancel</button><button class="btn btn-pri" onclick="saveStaff('${id||''}')">Save</button>`);
}
function saveStaff(id){
  const name=document.getElementById('sm-name').value.trim();
  if(!name){alert('Name required');return;}
  const obj={name,role:document.getElementById('sm-role').value.trim(),active:true};
  if(id){DB.staff=DB.staff.map(s=>s.id===id?{...s,...obj}:s);}
  else{DB.staff.push({...obj,id:'s'+Date.now()});}
  auditLog(id?'Edited staff':'Added staff',name);
  dbSave();closeModal();populateStaffSelect();renderStaff(document.getElementById('page-root'));
}
function toggleStaff(id){
  DB.staff=DB.staff.map(s=>s.id===id?{...s,active:!s.active}:s);
  auditLog('Toggled staff status',id);
  dbSave();populateStaffSelect();renderStaff(document.getElementById('page-root'));
}
function deleteStaff(id){
  const s=DB.staff.find(x=>x.id===id);
  if(!s)return;
  if(currentStaff&&currentStaff.id===id){alert('Cannot delete the currently signed-in staff member. Please sign out first.');return;}
  if(!confirm(`Permanently remove "${s.name}" from the system?\n\nThis cannot be undone. Their audit log entries are preserved.`))return;
  DB.staff=DB.staff.filter(x=>x.id!==id);
  auditLog('Deleted staff member',s.name);
  dbSave();populateStaffSelect();renderStaff(document.getElementById('page-root'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FACILITIES ADMIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFacilitiesAdmin(root){
  root.innerHTML=`
  <div class="alert al-warn">âš ï¸ <strong>Caution:</strong> Removing a facility is permanent. An error check will run before removal â€” assets must be transferred out first.</div>
  <div class="sec-hd"><div class="sec-title">Facilities</div><button class="btn btn-pri btn-sm" onclick="openFacilityModal(null)">+ Add Facility</button></div>
  <div class="tbl-wrap"><table><thead><tr><th>ID</th><th>Name</th><th>Assets</th><th>Status</th><th>Actions</th></tr></thead><tbody>
  ${DB.facilities.map(f=>{
    const assetCount=DB.assets.filter(a=>a.facility===f.id).length;
    return`<tr>
      <td><span class="fac-tag fac-${f.id}">${f.id}</span></td>
      <td style="font-weight:600;color:var(--t1)">${esc(f.name)}</td>
      <td style="font-family:'JetBrains Mono',monospace">${assetCount}</td>
      <td><span class="pill pill-${f.active?'green':'red'}">${f.active?'Active':'Deactivated'}</span></td>
      <td><div style="display:flex;gap:5px">
        <button class="btn btn-xs btn-sec" onclick="openFacilityModal('${f.id}')">âœï¸ Edit</button>
        ${f.active?`<button class="btn btn-xs btn-danger" onclick="removeFacility('${f.id}')">ğŸ—‘ Remove</button>`:''}
      </div></td>
    </tr>`;
  }).join('')}
  </tbody></table></div>
  <div style="margin-top:18px;background:var(--surface2);border-radius:8px;padding:14px">
    <div class="card-hd" style="margin-bottom:8px">Pre-removal Checklist</div>
    <div style="font-size:.77rem;color:var(--t2);line-height:2">
      Before removing a facility:<br>
      1. Transfer all assets to another facility via Asset Management â†’ Move Asset<br>
      2. Export all WSH logs and first aid records<br>
      3. The system will block removal if assets remain<br>
      4. All historical data (audit logs, WSH history) is preserved even after removal
    </div>
  </div>`;
}
function openFacilityModal(id){
  const f=id?DB.facilities.find(x=>x.id===id):null;
  showModal(id?'Edit Facility':'Add Facility',`
  <div class="fg"><label class="flbl">Facility ID (e.g. T11C01)</label><input class="finput" id="fm-id" value="${esc(f?.id||'')}" ${id?'readonly':''}></div>
  <div class="fg"><label class="flbl">Display Name</label><input class="finput" id="fm-name" value="${esc(f?.name||'')}"></div>`,
  `<button class="btn btn-sec" onclick="closeModal()">Cancel</button><button class="btn btn-pri" onclick="saveFacility('${id||''}')">Save</button>`);
}
function saveFacility(id){
  const fid=document.getElementById('fm-id').value.trim().toUpperCase();
  const fname=document.getElementById('fm-name').value.trim();
  if(!fid||!fname){alert('ID and Name required');return;}
  if(id){DB.facilities=DB.facilities.map(f=>f.id===id?{...f,name:fname}:f);}
  else{
    if(DB.facilities.find(f=>f.id===fid)){alert('Facility ID already exists');return;}
    DB.facilities.push({id:fid,name:fname,active:true,color:'blue'});
    // Init first aid
    DB.firstAid[fid]=[];
  }
  auditLog(id?'Edited facility':'Added facility',fid);
  dbSave();closeModal();populateFacilitySelect();renderFacilitiesAdmin(document.getElementById('page-root'));
}
function removeFacility(id){
  const assets=DB.assets.filter(a=>a.facility===id);
  if(assets.length>0){
    alert(`âŒ Cannot remove ${id} â€” ${assets.length} asset(s) still assigned.\n\nPlease move all assets to another facility first via Assets â†’ Move Asset.`);
    return;
  }
  if(!confirm(`Are you sure you want to remove facility "${id}"?\n\nWSH logs and audit history are preserved.\nThis cannot be undone.`))return;
  DB.facilities=DB.facilities.map(f=>f.id===id?{...f,active:false}:f);
  auditLog('Removed facility',id);
  dbSave();
  if(currentFacility===id){
    const active=DB.facilities.find(f=>f.active);
    if(active)switchFacility(active.id);
  }
  populateFacilitySelect();renderFacilitiesAdmin(document.getElementById('page-root'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PASSCODE RECORDS (Password-protected vault)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Vault uses a master password to XOR-encrypt stored passcodes.
// Not military-grade, but prevents casual snooping in localStorage.
let _vaultUnlocked=false;
let _vaultKey='';

function xorEncrypt(text,key){
  if(!key)return text;
  return btoa(Array.from(text).map((c,i)=>String.fromCharCode(c.charCodeAt(0)^key.charCodeAt(i%key.length))).join(''));
}
function xorDecrypt(enc,key){
  if(!key)return enc;
  try{const raw=atob(enc);return Array.from(raw).map((c,i)=>String.fromCharCode(c.charCodeAt(0)^key.charCodeAt(i%key.length))).join('');}catch(e){return null;}
}
function vaultHash(pw){
  // Simple deterministic check â€” store a known test string encrypted
  return xorEncrypt('FABLAB_VAULT_OK',pw);
}

function renderPasscodes(root){
  root.innerHTML=`
  <div class="sec-hd"><div class="sec-title">ğŸ” Passcode Records</div></div>
  <div class="alert al-warn">âš ï¸ Passcode records are encrypted with a master password. Only authorised staff should access this vault. All access is logged.</div>
  <div id="vault-ui"></div>`;
  if(!_vaultUnlocked){
    renderVaultLock();
  } else {
    renderVaultContents();
  }
}

function renderVaultLock(){
  const ui=document.getElementById('vault-ui');if(!ui)return;
  const hasMaster=!!DB.vaultHash;
  ui.innerHTML=`
  <div class="card" style="max-width:420px;margin:24px auto">
    <div style="text-align:center;margin-bottom:18px">
      <div style="font-size:2.5rem">ğŸ”’</div>
      <div style="font-size:1rem;font-weight:700;margin-top:8px">${hasMaster?'Enter Master Password':'Set Master Password'}</div>
      <div style="font-size:.82rem;color:var(--t3);margin-top:4px">${hasMaster?'Enter your vault master password to unlock passcode records':'Create a master password to protect your passcode vault'}</div>
    </div>
    <div class="fg"><label class="flbl">${hasMaster?'Master Password':'New Master Password'}</label><input class="finput" type="password" id="vault-pw" placeholder="Enter password..." onkeydown="if(event.key==='Enter')unlockVault()"></div>
    ${!hasMaster?`<div class="fg" style="margin-top:8px"><label class="flbl">Confirm Password</label><input class="finput" type="password" id="vault-pw2" placeholder="Confirm password..."></div>`:''}
    <div style="margin-top:14px;display:flex;gap:8px">
      <button class="btn btn-pri" style="flex:1" onclick="${hasMaster?'unlockVault()':'setMasterPassword()'}">ğŸ”“ ${hasMaster?'Unlock Vault':'Create Vault'}</button>
    </div>
    <div id="vault-err" style="color:var(--red);font-size:.8rem;margin-top:8px;text-align:center"></div>
  </div>`;
}

function setMasterPassword(){
  const pw=document.getElementById('vault-pw')?.value;
  const pw2=document.getElementById('vault-pw2')?.value;
  if(!pw||pw.length<4){document.getElementById('vault-err').textContent='Password must be at least 4 characters.';return;}
  if(pw!==pw2){document.getElementById('vault-err').textContent='Passwords do not match.';return;}
  DB.vaultHash=vaultHash(pw);
  _vaultKey=pw;_vaultUnlocked=true;
  dbSave();auditLog('Created vault master password','Passcode vault initialised');
  renderVaultContents();
}

function unlockVault(){
  const pw=document.getElementById('vault-pw')?.value;
  if(!pw){document.getElementById('vault-err').textContent='Enter your password.';return;}
  const test=xorDecrypt(DB.vaultHash,pw);
  if(test==='FABLAB_VAULT_OK'){
    _vaultKey=pw;_vaultUnlocked=true;
    auditLog('Unlocked passcode vault',currentStaff?.name||'Unknown');
    renderVaultContents();
  } else {
    document.getElementById('vault-err').textContent='Incorrect password.';
    auditLog('Failed vault unlock attempt',currentStaff?.name||'Unknown');
  }
}

function lockVault(){
  _vaultUnlocked=false;_vaultKey='';
  navigate('passcodes');
}

function renderVaultContents(){
  const ui=document.getElementById('vault-ui');if(!ui)return;
  const records=(DB.passcodes||[]).map(r=>({...r,_dec:xorDecrypt(r.encPass,_vaultKey)}));
  ui.innerHTML=`
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:8px">
    <div style="display:flex;align-items:center;gap:8px">
      <span style="color:var(--green);font-size:.85rem">ğŸ”“ Vault Unlocked</span>
      <button class="btn btn-xs btn-danger" onclick="lockVault()">ğŸ”’ Lock</button>
    </div>
    <button class="btn btn-pri btn-sm" onclick="openPasscodeModal(null)">+ Add Record</button>
  </div>
  <div class="tbl-wrap"><table>
    <thead><tr><th>Label / System</th><th>Username / ID</th><th>Password</th><th>Category</th><th>Notes</th><th>Last Updated</th><th>Actions</th></tr></thead>
    <tbody>
    ${records.length===0?`<tr><td colspan="7"><div class="empty"><div class="empty-icon">ğŸ”</div><div>No passcode records. Add your first entry.</div></div></td></tr>`
    :records.map(r=>`<tr>
      <td><div style="font-weight:600;color:var(--t1)">${esc(r.label)}</div>${r.url?`<div style="font-size:.7rem;color:var(--t3)">${esc(r.url)}</div>`:''}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:.8rem">${esc(r.username||'â€”')}</td>
      <td>
        <div style="display:flex;align-items:center;gap:6px">
          <span id="pw-${r.id}" style="font-family:'JetBrains Mono',monospace;font-size:.82rem;letter-spacing:.05em">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span>
          <button class="btn btn-xs btn-sec" onclick="togglePwVis('${r.id}','${encodeURIComponent(r._dec||'')}')">ğŸ‘</button>
          <button class="btn btn-xs btn-sec" onclick="copyToClip('${encodeURIComponent(r._dec||'')}')">ğŸ“‹</button>
        </div>
      </td>
      <td><span class="pill pill-${r.category==='Network'?'blue':r.category==='Equipment'?'teal':r.category==='Software'?'purple':'orange'}">${esc(r.category||'Other')}</span></td>
      <td style="font-size:.78rem;color:var(--t2);max-width:150px;white-space:normal">${esc(r.notes||'â€”')}</td>
      <td style="font-size:.74rem;color:var(--t3);font-family:'JetBrains Mono',monospace">${fmtDate(r.updatedAt)}</td>
      <td><div style="display:flex;gap:3px">
        <button class="btn btn-xs btn-sec" onclick="openPasscodeModal('${r.id}')">âœï¸</button>
        <button class="btn btn-xs btn-danger" onclick="deletePasscode('${r.id}')">ğŸ—‘</button>
      </div></td>
    </tr>`).join('')}
    </tbody>
  </table></div>`;
}

function togglePwVis(id,encPw){
  const el=document.getElementById('pw-'+id);if(!el)return;
  el.textContent=el.textContent.includes('â€¢')?decodeURIComponent(encPw):'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
}
function copyToClip(encPw){
  const pw=decodeURIComponent(encPw);
  navigator.clipboard.writeText(pw).then(()=>{
    const btn=event.target;const orig=btn.textContent;
    btn.textContent='âœ“';setTimeout(()=>{btn.textContent=orig;},1500);
  }).catch(()=>alert('Clipboard not available. Use the show button.'));
}

function openPasscodeModal(id){
  if(!_vaultUnlocked){alert('Unlock the vault first.');return;}
  const r=id?(DB.passcodes||[]).find(x=>x.id===id):null;
  const dec=r?xorDecrypt(r.encPass,_vaultKey)||'':'';
  const v=k=>r?esc(r[k]||''):'';
  showModal(id?'Edit Passcode Record':'Add Passcode Record',`
  <div class="frow"><div class="fg"><label class="flbl">Label / System Name *</label><input class="finput" id="pc-label" value="${v('label')}" placeholder="e.g. WiFi Router Admin, Door Lock Code"></div><div class="fg"><label class="flbl">Category</label><select class="fsel" id="pc-cat">${['Network','Equipment','Software','Door/Access','Other'].map(c=>`<option ${r&&r.category===c?'selected':''}>${c}</option>`).join('')}</select></div></div>
  <div class="frow"><div class="fg"><label class="flbl">Username / ID</label><input class="finput" id="pc-user" value="${v('username')}" placeholder="admin, user ID, etc."></div><div class="fg"><label class="flbl">Password / Passcode</label><input class="finput" type="password" id="pc-pass" value="${esc(dec)}" placeholder="Enter passcode..."></div></div>
  <div class="fg" style="margin-bottom:10px"><label class="flbl">URL / Location</label><input class="finput" id="pc-url" value="${v('url')}" placeholder="192.168.1.1 or https://..."></div>
  <div class="fg" style="margin-bottom:10px"><label class="flbl">Notes</label><textarea class="ftxt" id="pc-notes" rows="2">${v('notes')}</textarea></div>`,
  `<button class="btn btn-sec" onclick="closeModal()">Cancel</button><button class="btn btn-pri" onclick="savePasscode('${id||''}')">ğŸ’¾ Save</button>`);
}
function savePasscode(id){
  if(!_vaultUnlocked){alert('Vault is locked.');return;}
  const label=document.getElementById('pc-label').value.trim();
  if(!label){alert('Label required.');return;}
  const rawPw=document.getElementById('pc-pass').value;
  const obj={label,category:document.getElementById('pc-cat').value,username:document.getElementById('pc-user').value.trim(),encPass:xorEncrypt(rawPw,_vaultKey),url:document.getElementById('pc-url').value.trim(),notes:document.getElementById('pc-notes').value.trim(),updatedAt:new Date().toISOString(),updatedBy:currentStaff?.name||'Unknown'};
  if(!DB.passcodes)DB.passcodes=[];
  if(id){DB.passcodes=DB.passcodes.map(r=>r.id===id?{...r,...obj}:r);}
  else{DB.passcodes.push({...obj,id:'PC'+Date.now()});}
  auditLog(id?'Updated passcode record':'Added passcode record',label);
  dbSave();closeModal();renderVaultContents();
}
function deletePasscode(id){
  if(!_vaultUnlocked){alert('Vault is locked.');return;}
  const r=DB.passcodes?.find(x=>x.id===id);if(!r)return;
  if(!confirm(`Delete record "${r.label}"? This cannot be undone.`))return;
  DB.passcodes=DB.passcodes.filter(x=>x.id!==id);
  auditLog('Deleted passcode record',r.label);
  dbSave();renderVaultContents();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUDIT LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAuditLog(root){
  const logs=DB.auditLog.slice(0,100);
  root.innerHTML=`
  <div class="sec-hd"><div class="sec-title">Audit Log</div>
    <div style="display:flex;gap:7px"><button class="btn btn-sec btn-sm" onclick="exportAuditLog()">â¬‡ Export</button></div>
  </div>
  <div style="font-size:.72rem;color:var(--t3);margin-bottom:12px">All actions by all staff across all facilities are recorded here. Showing last 100 entries.</div>
  ${logs.length===0?`<div class="empty"><div class="empty-icon">ğŸ“‹</div><div>No audit entries yet</div></div>`
  :`<div class="tbl-wrap"><table><thead><tr><th>Timestamp</th><th>Staff</th><th>Facility</th><th>Action</th><th>Details</th></tr></thead><tbody>
  ${logs.map(l=>`<tr>
    <td style="font-family:'JetBrains Mono',monospace;font-size:.68rem;white-space:nowrap">${fmtDateTime(l.ts)}</td>
    <td><span style="font-size:.72rem;color:var(--blue2);font-weight:600">${esc(l.staff)}</span></td>
    <td><span class="fac-tag fac-${l.facility||'T11C01'}" style="font-size:.6rem">${esc(l.facility||'â€”')}</span></td>
    <td style="color:var(--t1);font-size:.75rem;font-weight:500">${esc(l.action)}</td>
    <td style="font-size:.72rem;color:var(--t3);max-width:200px;white-space:normal">${esc(l.details)}</td>
  </tr>`).join('')}
  </tbody></table></div>`}`;
}
function exportAuditLog(){
  const lines=['AUDIT LOG EXPORT','='.repeat(60),`Exported: ${fmtDateTime(new Date().toISOString())}`,'',...DB.auditLog.map(l=>`[${fmtDateTime(l.ts)}] ${l.staff} @ ${l.facility||'â€”'} Â· ${l.action}${l.details?' â†’ '+l.details:''}`)];
  const blob=new Blob([lines.join('\n')],{type:'text/plain'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=`audit_log_${todayStr()}.txt`;a.click();URL.revokeObjectURL(url);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init(){
  await dbLoad();
  seedData();
  // Apply initial facility theme
  document.documentElement.setAttribute('data-facility', currentFacility);
  populateStaffSelect();
  populateFacilitySelect();
  updateBadges();
  navigate('dashboard');
  // Clock in signin bar
  setInterval(()=>{
    const t=document.getElementById('signin-time');
    if(t&&currentStaff)t.textContent=new Date().toLocaleString('en-SG');
    updateBadges();
    // Re-render analytics if on that page
    if(currentPage==='maintenance'&&maintTab==='faulty')renderMaintContent();
  },60000);
}
init();
</script>
</body>
</html>
